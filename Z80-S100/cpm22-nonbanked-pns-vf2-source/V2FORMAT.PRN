


TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 1




                        ;**********************************************
                        ;*             V2FORMAT.ASM                   *
                        ;*             FORMAT PROGRAM                 *
                        ;*        WITH READ VERIFICATION              *
                        ;*              12/15/03                      *
                        ;**********************************************                   
                        
   0080                 VERS    ==      80H     ;VERSION NUMBER
                        
                                .Z80            ;Z80 CODE USED
                                .PHEX           ;DDT COMPATIBLE
                                .PABS
                                .XLINK
   0100                         .LOC    100H    ;CP/M COMPATIBLE
                        
                        ; AS YOU MAKE CHANGES, UPDATE THE VERSION INFO
                        
   0001                 FVER    ==      1       ;INITIAL
   0000                 FVER1   ==      0       ;RELEASE
   0000                 FVER0   ==      0       ;TEST
                        
                        
                        ; == NOTE THE "ALL-CAPS TEXT", WHICH WAS COMMON, DUE TO
                        ; == LINE-PRINTERS, AND EVEN CRT'S THAT DID NOT
                        ; == SUPPORT LOWER-CASE TEXT.
                        ;
                        ;
                        ; DISK FORMAT PROGRAM FOR CP/M 2.1 OR GREATER.
                        ;
                        ; WRITTEN BY 
                        ;
                        ;==================================================
                        ; MANY THANKS TO BOHDAN TASHCHUK FOR THIS CODE
                        ; AND HIS QUALITY SUPPORT OF THOSE WHO USED IT
                        ;==================================================
                        ;
                        ;     B. JONES 1981
                        ; - 1024 BYTE SECTOR SUPPORT ADDED
                        ; - ADDED 9, 512 BYTE SECTORS FOR EACH SYSTEM TRACK
                        ;   THIS ALLOWS A LARGER BIOS TO BE CREATED, FOR
                        ;   SUPPORTING MORE DRIVES, HARD DRIVES OR SPECIAL FUNCTIONS
                        ; - FORMAT OPTION "SAVE" FEATURE ADDED
                        ; - READ-VERIFY AFTER FULL FORMAT ADDED - BIOS DEPENDENT
                        ; - INSERT ROUTINE TO UN-JAM HEADS AT START OF FORMATTING
                        ; - ALLOW SAFE FORMAT OF 'A' DRIVE
                        ; - ALLOW FORMATS UNDER MP/M-80 1.1 OR 1.2
                        ; - ADDED PARALLEL SUPPORT FOR TARBELL DD DMA FDC
                        ;   THIS PROGRAM WILL CHECK TO SEE WHICH CONTROLLER IS
                        ;   IN SYSTEM AND WORK WITH IT.
                        ;
                        ;      B. JONES NOV. 2003
                        ; - VERSAFLOPPY II SUPPORT ADDED
                        ; - 10 & 11, 1024 BYTE SECTORS PER TRACK ADDED FOR 3.5" HD DISKS
                        ; - STANDARD DISK FORMATS ALLOWED (NO SPECIAL SYSTEM TRACKS)
                        ; - READ-VERIFY AFTER EACH TRACK FORMATED - NOT BIOS DEPENDENT






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 2




                        ; - "QUIT" FUNCTION FOR ANY OPTION ALLOWED
                        ; - USER ENABLE/DISABLE READ VERIFICATION
                        ; - REMOVED MP/M-80 SUPPORT
                        ; - REMOVED TARBELL DD DMA FDC SUPPORT
                        ; - ADDED SUPPORT FOR BOTH VF II AND Z3S CONTROLLERS
                        ; - ADDED BUFFER SIZE TESTING
                        ;   
                        
                        
                        
                        ;******************************************************
                        ; THIS PROGRAM "FORMATS" A SOFT SECTORED FLOPPY DISK.
                        ; THE FORMATING FOLLOWS THE GUIDELINES FOR IBM
                        ; COMPATIBILITY. THE FOLLOWING OPTIONS ARE AVAILABLE:
                        ;
                        ;       FORMAT ALL TRACKS OR SYSTEM TRACKS ONLY
                        ;       5 INCH OR 8 INCH DISK
                        ;       SINGLE OR DOUBLE DENSITY DISK
                        ;       SINGLE OR DOUBLE SIDED DISK
                        ;       128, 256, 512 OR 1024 BYTE SECTORS
                        ;       NORMAL OR EXTENDED NUMBER OF TRACKS 
                        ;                   == NOTE == 
                        ; EXTENDED TRACKS OMITTED. WERE ONLY USED FOR OLD 5"
                        ; MINI-FLOPPIES, GIVING 39 TRACKS INSTEAD OF 35.
                        ; THE CODE IS LEFT IN, BUT COMMENTED-OUT.
                        ; IF YOU NEED IT, REMOVE THE ";" CHARACTERS, AND
                        ; YOU ARE ON YOUR OWN! (THERE MAY BE SOME GOOD
                        ; REASON FOR IT BEING DISABLED!)
                        
                        































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 3




                        ; MACROS TO MAKE TRACK IMAGE FOR FDC TRACK WRITES
                        
                                .DEFINE RB[VAR,%A]=[
                                LDA     VAR'L   ;GET LENGTH
                                ORA     A
                                JRZ     %A      ;EXIT IF NULL
                                MOV     C,A
                                MVI     B,0
                                MOV     D,H
                                MOV     E,L
                                INX     D
                                LDA     VAR'V   ;GET VALUE
                                MOV     M,A
                                LDIR            ;GENERATE NEXT PATTERN
                        %A:]
                                .DEFINE RW[VAR,%A]=[
                                LBCD    VAR'L   ;GET LENGTH
                                MOV     A,B
                                ORA     C
                                JRZ     %A      ;EXIT IF NULL
                                MOV     D,H
                                MOV     E,L
                                INX     D
                                LDA     VAR'V   ;GET VALUE
                                MOV     M,A
                                LDIR            ;GENERATE NEXT PATTERN
                        %A:]


































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 4




                        
                        
   0000                 FALSE   ==      0H      ;TRUE AND FALSE VALUES
   FFFF                 TRUE    ==      #FALSE
   FFFF                 Z3S     ==      TRUE    ;THIS VERSION FOR THE Z3S BOARD
                        ;MLIST  ==      FALSE   ;MACRO EXPANSION FLAG
   FFFF                 MLIST   ==      TRUE    ;MACRO EXPANSION FLAG
                        
                        ;***************************************************
                        ;                 GENERAL EQUATES.
                        ;***************************************************
                        
   0005                 BDOS    ==      5
   000D                 CR      ==      13
   000A                 LF      ==      10
   0003                 CONTLC  ==      3       ;<CONTROL-C> CHAR
   0007                 BELL    ==      7
   001A                 CLEAR   ==      26      ;ZEUS80 CLEAR SCREEN
                        
                        ;***************************************************
                        ;         PIO FLOPPY DISK EQUATES.
                        ;***************************************************
                        
                        ; CONTROL BYTE VALUES, USED TO SET THE CONTROL
                        ; REG. FOR PROPER HARDWARE TO FORMAT VALUES
                        
                        ;FOR VERSAFLOPPY II
                        
   0007                 DBWAIT  ==      7       ;WAIT BIT
   0004                 DBSIDE  ==      4       ;SIDE SELECT BIT
   00F0                 DCMD8S  ==      0F0H    ;8", SING DENS, SIDE 0, NO WAIT
   00B0                 DCMD8D  ==      0B0H    ;8", DOUB DENS, SIDE 0, NO WAIT
   00D0                 DCMD5S  ==      0D0H    ;5", SING DENS, SIDE 0, NO WAIT
   0090                 DCMD5D  ==      90H     ;5", DOUB DENS, SIDE 0, NO WAIT
                        
                        ; FOR Z3S FDC BOARD
                        
   0006                 ZBWAIT  ==      6       ;WAIT BIT
   0004                 ZBSIDE  ==      4       ;SIDE SELECT BIT
   0050                 ZCMD8S  ==      50H     ;8", SING DENS, SIDE 0, NO WAIT
   00D0                 ZCMD8D  ==      0D0H    ;8", DOUB DENS, SIDE 0, NO WAIT
   0070                 ZCMD5S  ==      70H     ;5", SING DENS, SIDE 0, NO WAIT
   00F0                 ZCMD5D  ==      0F0H    ;5", DOUB DENS, SIDE 0, NO WAIT
                        
                        ; FDC PORTS
                        
   0053                 DCMD    ==      53H
   0054                 W       ==      054H    ;WDC 179X PORTS
   0054                 WCMD    ==      W+0     ;COMMAND REG
   0054                 WSTAT   ==      W+0     ;STATUS REG
   0055                 WTRACK  ==      W+1     ;TRACK REG
   0056                 WSECT   ==      W+2     ;SECTOR REG
   0057                 WDATA   ==      W+3     ;DATA I/O PORT
                        
   00D0                 WFCINT  ==      0D0H    ;FORCED INTERRUPT COMMAND






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 5




   001B                 SSEEK   ==      1BH     ;A REALLY SLOW SEEK COMMAND
                        
                        
                        ;***************************************************
                        ;          COMMON 179X COMMANDS/STATUS
                        ;***************************************************
                        
   005B                 WSTIN   ==      01011011B ;STEP IN
   000B                 WHOMEF  ==      00001011B ;HOME
   00F4                 WWRTRK  ==      11110100B ;WRITE TRACK
   00A0                 WWRIT   ==      10100000B ;WRITE SECTOR 
                        
   009C                 WSSTIN  ==      10011100B ;STEP IN STATUS
   009C                 WSHOME  ==      10011100B ;HOME STATUS
   00E4                 WSWRTR  ==      11100100B ;WRITE TRACK STATUS
   00FC                 WSWRIT  ==      11111100B ;WRITE SECTOR STATUS
                        
   0002                 WBTRK0  ==      2
   0000                 WBBUSY  ==      0
                        
                        
   0100                 FORMAT:
   0100    31 0100              LXI     SP,100H ;VALIDATE THE STACK POINTER
                        
                        
                        ;***************************************************
                        ;        SIGN ON AND GET FORMAT DATA
                        ;***************************************************
                        
   0103                 SIGONF:
   0103    AF                   XRA     A
   0104    32 23AC              STA     FINFLG          ;ALLOW READS IF NEEDED
   0107    3A 1F74              LDA     QUFLAG
   010A    FE00                 CPI     0
   010C    C2 026F              JNZ     NOSHOW
                        
   010F                 ENTRE0:
   010F    CD 1144              CALL    MSGF
   0112    1A                   .BYTE   CLEAR
   0113    202020202020         .ASCII  \                              VFORMAT Disk Format\
   0144    0D0A                 .BYTE   CR,LF
   0146    202020202020         .ASCII  \                                     V \
   016D    312E302E30           .BYTE   (FVER)@10+'0','.',(FVER1)@10+'0','.',(FVER0)@10+'0'
   0172    0D8A                 .BYTE   CR,LF+80H
                        
   0174    CD 1144              CALL    MSGF
   0177    202020202020         .ASCIS  \                             for VF II disk controller\
   01AD                 COMESS:
   01AD    CD 1144              CALL    MSGF
   01B0    0D0A0A               .BYTE   CR,LF,LF
   01B3    202020202020         .ASCII  \                                       NOTE:\
   01DF    0D0A0A               .BYTE   CR,LF,LF
   01E2    202020202020         .ASCII  \            3.5" and 5.25" HD PC drives are supported as 8" drives.\
   0225    0D0A                 .BYTE   CR,LF
   0227    202020202020         .ASCII  \          All selectable 5" formats are for older mini-floppy drives.\






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 6




   026C    0D0A8A               .BYTE   CR,LF,LF+80H
                        
                        ;***************************************************
                        ; ASK THE USER FOR THE DESIRED OPTIONS. TELL HIM THE
                        ; OPTIONS HE SELECTED.
                        ;***************************************************
                        
   026F                 NOSHOW:
   026F    21 1F74              LXI     H,QUFLAG
   0272    7E                   MOV     A,M     
   0273    B7                   ORA     A       ;DID WE ASK QUESTIONS ALREADY
   0274    2005                 JRNZ    ..TELL  ;YES
   0276    3C                   INR     A       ;REMEMBER NOT TO ASK AGAIN
   0277    77                   MOV     M,A
                        
   0278    CD 05FC      ..ASK:  CALL    QUEST   ;ASK HIM ABOUT THE OPTIONS
                        
   027B    CD 08D4      ..TELL: CALL    TELL    ;TELL HIM THE OPTIONS
                        
                        ;***************************************************
                        ; ASK THE USER WHICH DISK DRIVE HAS THE DISK TO BE
                        ; FORMATTED. ALLOW HIM TO GO BACK TO CHANGE THE
                        ; OPTIONS OR TO QUIT.
                        ;***************************************************
                        
   027E    CD 1144      ..GET:  CALL    MSGF
   0281    0D0A0A               .BYTE   CR,LF,LF
   0284    202020202020         .ASCII  \                           Type disk letter to format\
   02B9    0D0A                 .BYTE   CR,LF
   02BB    6F7220582074         .ASCII  \or X to change options, S to save format or Q to stop \
   02F1    28412C20422C         .ASCIS  \(A, B, C, D, X, S, Q): \ 
                        
   0308    21 14CE              LXI     H,DROK
   030B    CD 1150              CALL    GETOK
   030E    FE58                 CPI     'X'     ;CHANGE OPTIONS
   0310    C2 031A              JNZ     ..ASKC  ;YES
   0313    CD 1144              CALL    MSGF
   0316    9A                   .BYTE   CLEAR+80H
   0317    C3 0278              JMP     ..ASK
                        
   031A                 ..ASKC:
   031A    FE53                 CPI     'S'
   031C    CA 1195              JZ      SAVEIT  ;MAKE NEW COPY OF FORMAT
   031F    FE51                 CPI     'Q'
   0321    CA 21B4              JZ      GOBAK   ;QUIT
                        
   0324    D641                 SUI     'A'     ;TURN LETTER INTO BINARY
   0326    32 1F80              STA     DRIVE   ;THIS IS THE DRIVE TO USE
                        
   0329    FE00                 CPI     0
   032B    C2 0376              JNZ     DOIT
                        
                        ; FOR THE SYSTEM DRIVE, WE WARN USER TO REMOVE THE CURRENT DISKETTE
                        
   032E    CD 1144              CALL    MSGF






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 7




   0331    1A0D0A0A             .BYTE   CLEAR,CR,LF,LF
   0335    52656D6F7665         .ASCIS  \Remove system disk, insert new disk & enter F to format :\
                        
   036E    21 14DD              LXI     H,FOROK
   0371    CD 1150              CALL    GETOK
   0374    184A                 JMPR    DOIT1
                        
   0376                 DOIT:
   0376    CD 1144              CALL    MSGF
   0379    1A0D0A0A             .BYTE   CLEAR,CR,LF,LF
   037D    456E73757265         .ASCIS  \Ensure disk to format is placed in drive, enter F to format :\
   03BA    21 14DD              LXI     H,FOROK
   03BD    CD 1150              CALL    GETOK
                        
                        ;***********************************************************
                        ; FORMAT THE SELECTED DISK.
                        ; DO SYSTEM TRACKS FIRST IN SINGLE DENSITY 512 BYTE SECTORS
                        ; IF THE 'S', STANDARD FORMAT OPTION WAS SELECTED, WE
                        ; FIX THIS UP LATER TO MAKE ALL TRACKS THE SAME.
                        ;***********************************************************
                        
   03C0                 DOIT1:
   03C0    3A 1F76              LDA     SISAV   ;DISK SIZE
   03C3    32 1F87              STA     SIZE
   03C6    3E35                 MVI     A,'5'   ;SECTOR SIZE ON SYSTEM TRACKS
   03C8    32 1F89              STA     SSIZ
   03CB    3A 1F76              LDA     SISAV   ;EIGHT INCH DISK
   03CE    FE38                 CPI     '8'
   03D0    280E                 JRZ     ..EIG0  ;YES
   03D2    3E33                 MVI     A,'3'
   03D4    32 1F89              STA     SSIZ
                        
   03D7    3E44         ..FIV0: MVI     A,'D'   ;DOUBLE DENS SYS TRACKS ON 5"
   03D9    32 1F88              STA     DEN
   03DC    3E02                 MVI     A,2     ;LAST SYSTEM TRACK
   03DE    180C                 JMPR    ..J0
                        
                        ;****************************************************
                        ;    SET POINTER TO SPECIAL SYSTEM TRACK FORMAT
                        ;  THIS WRITES 9 512 BYTE SECTORS ON SYSTEM TRACKS
                        ;****************************************************
                        
   03E0    3E54         ..EIG0: MVI     A,'T'   ;SINGLE DENS SYS TRACKS ON 8"
                                                ;POINTS TO SYSTEM TRACK TABLE
   03E2    32 1F88              STA     DEN
                        
   03E5    3E53                 MVI     A,'S'
   03E7    32 1F7C              STA     SDFORM  ;JUST SIDE 0
                        
   03EA    3E01                 MVI     A,1     ;LAST SYSTEM TRACK
                        
   03EC    32 1F84      ..J0:   STA     MAXTRK
   03EF    AF                   XRA     A       ;START AT TRACK 0
   03F0    32 1F83              STA     TRAKK
   03F3    CD 0BA9              CALL    LTABLE  ;LOCATE CORRECT TABLE






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 8




                        
                        ;***************************************************
                        ;  NOW SET 'T' DENSITY TO CORRECT 'S' DENSITY
                        ; THE FORMER 'T' SETTING WAS USED TO ALLOW
                        ; THE TRACK BUILDING ROUTINE TO LOCATE THE
                        ; SPECIAL SYSTEM TRACK PARAMETER TABLE.
                        ; BUT NOW WE SET THE 'S' SINGLE DENSITY MARKER
                        ; IN PLACE SO THAT THE CORRECT CONTROL BYTE
                        ; WILL BE PICKED UP FOR THE ACTUAL PHTSICAL I/O.
                        ;***************************************************
                        
   03F6    3E53                 MVI     A,'S'   ;CORRECT DENSITY
   03F8    32 1F88              STA     DEN     ;AND SET IN PLACE
   03FB    3A 1F7B              LDA     STDSAV  ;GET SYSTEM TRACK FORMAT
   03FE    FE56                 CPI     'V'     ;SEE IF V2BIOS TYPE
   0400    CA 043E              JZ      VFFORM  ;DO V2BIOS SYSTEM TRACKS
                        
                        ; GOSH! AFTER ALL THAT WE NOW SEE THE USER WANTS
                        ; 'S' STANDARD TRACKS. OH WELL!
                        ; DO 'STANDARD' SYSTEM TRACK FORMAT HERE
                        
   0403    3A 1F78              LDA     LESAV   ;USER SECTOR SIZE
   0406    32 1F89              STA     SSIZ
   0409    3A 1F77              LDA     DESAV   ;USER TRACK DENSITY
   040C    32 1F88              STA     DEN
   040F    3A 1F7A              LDA     SDSAV   ;USER SIDES
   0412    32 1F7C              STA     SDFORM
                        
                        
   0415    CD 0BA9              CALL    LTABLE
   0418    CD 0D59              CALL    CTRAKK  ;CREATE PROTOTYPE TRACK IMAGE
   041B    CD 0F98              CALL    SELECT  ;SELECT DRIVE, SET Z3S BYTE
   041E    32 1F82              STA     Z3SSYS  ;SAVE SYSTEM TRACK Z3S BYTE
                        
   0421    CD 0F55              CALL    HOMEF   ;RESTORE THE DRIVE
                        
                        ;  - B. JONES -
                        ; ADDED THIS SMALL OPERATION IN 1981.
                        ; IT SEEMS SOME DRIVES DID NOT HOME PROPERLY FROM THE 
                        ; ABOVE 'HOMEF' OPERATION, SO WE PUSH THE HEADS OUT
                        ; 20 TRACKS AND HOME AGAIN. IT COULD BE THAT, IF THE
                        ; HEADS WERE ALREADY AT HOME, THEY JAMMED WHEN THE 
                        ; ABOVE 'HOMEF' OPERATION WAS ISSUED. SO WE SEEK OUT
                        ; AND HOME AGAIN JUST TO COVER THAT EVENTUALITY.
                        
   0424    3E14                 MVI     A,20    ;TRACK 20
   0426    D357                 OUT     WDATA   ;SET IT
   0428    3E1B                 MVI     A,SSEEK ;DO A SLOW-RATE SEEK OUT
   042A    D354                 OUT     WCMD
   042C    CD 1138              CALL    FDONEF  ;GET THE ALL-DONE
   042F    CD 0F55              CALL    HOMEF   ;NOW HOME FROM A KNOWN POSITION
                        
                        ; OK. NOW WE CAN START TO FORMAT!
                        
   0432    CD 1144              CALL    MSGF






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 9




   0435    0D0A8A               .BYTE   CR,LF,LF+80H
                        
   0438    CD 0509              CALL    SUFORM  ;FORMAT SYSTEM TRACKS
   043B    C3 0461              JMP     DOUSER  ;NOW DO THE 'USER' OR DATA TRACKS
                        
                        ; HERE WE START THE 'S' STANDARD FORMAT OPERATION
                        ; SYSTEM TRACK FORMAT WILL = DATA TRACK FORMAT.
                        
   043E                 VFFORM:
   043E    CD 0D59              CALL    CTRAKK  ;CREATE PROTOTYPE TRACK IMAGE
   0441    CD 0F98              CALL    SELECT  ;SELECT DRIVE, SET Z3S BYTE
   0444    32 1F82              STA     Z3SSYS  ;SAVE SYSTEM TRACK Z3S BYTE
                        
   0447    CD 0F55              CALL    HOMEF   ;RESTORE THE DRIVE
                        
                        ; HERE WE UN-JAM THE HEADS AGAIN. IT SEEMS TO HAPPEN
                        ; ON SOME DRIVE TYPES. THIS FIXES THAT PROBLEM
                        
   044A    3E14                 MVI     A,20
   044C    D357                 OUT     WDATA
   044E    3E1B                 MVI     A,SSEEK
   0450    D354                 OUT     WCMD
   0452    CD 1138              CALL    FDONEF
   0455    CD 0F55              CALL    HOMEF
                        
   0458    CD 1144              CALL    MSGF
   045B    0D0A8A               .BYTE   CR,LF,LF+80H
                        
   045E    CD 0509              CALL    SUFORM  ;FORMAT SYSTEM TRACKS
                        
                        ;*****************************************************
                        ;             NOW FORMAT USER TRACKS
                        ;*****************************************************
                        
   0461                 DOUSER:
   0461    CD 0F03              CALL    STEPIN  ;MOVE TO FIRST USER TRACK
   0464    3A 1F7A              LDA     SDSAV
   0467    32 1F7C              STA     SDFORM
   046A    3A 1F78              LDA     LESAV   ;USER TRACK SECTOR SIZE
   046D    32 1F89              STA     SSIZ
   0470    3A 1F77              LDA     DESAV   ;USER TRACK DENSITY
   0473    32 1F88              STA     DEN
   0476    3A 1F76              LDA     SISAV   ;GET DISK SIZE
   0479    FE38                 CPI     '8'     ;EIGHT INCH DISK
   047B    280D                 JRZ     ..EIG1  ;YES
                        
   047D    3A 1F79      ..FIV1: LDA     NESAV   ;STANDARD OR EXTENDED TRACK
   0480    FE53                 CPI     'S'
   0482    3E22                 MVI     A,34    ;STANDARD MAX TRACK ON 5"
   0484    2806                 JRZ     ..J1    ;WAS STANDARD
   0486    3E27                 MVI     A,39    ;EXTENDED MAX TRACK ON 5"
   0488    1802                 JMPR    ..J1
                        
   048A    3E4C         ..EIG1: MVI     A,76    ;MAX TRACK ON 8"
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 10




   048C    32 1F84      ..J1:   STA     MAXTRK
                        
   048F    F3                   DI
                        
   0490    CD 0BA9              CALL    LTABLE  ;LOCATE CORRECT TABLE
   0493    CD 0D59              CALL    CTRAKK  ;CREATE PROTOTYPE IMAGE
   0496    3A 1F75              LDA     TRSAV   ;GET TRACK FORMAT FLAG
   0499    FE53                 CPI     'S'     ;FORMAT SYSTEM TRACKS ONLY
   049B    2806                 JRZ     ..FIN   ;YES, GO FINISH UP
   049D    CD 0F98              CALL    SELECT  ;SET USER TRACK Z3S CTRL BYTE
                        
   04A0    CD 0509              CALL    SUFORM  ;FORMAT USER TRACKS
                        
   04A3    CD 0F55      ..FIN:  CALL    HOMEF   ;RESTORE DRIVE
   04A6    3A 1F82              LDA     Z3SSYS  ;MAKE SYSTEM TRACK Z3S BYTE
   04A9    32 1F81              STA     Z3SBYT  ;   THE CURRENT Z3S BYTE
   04AC    3A 1F7B              LDA     STDSAV  ; GET SYSTEM TRACK TYPE
   04AF    FE56                 CPI     'V'
   04B1    C2 21B4              JNZ     GOBAK   ; IF NOT BIOS COMPATIBLE, EXIT
                        
   04B4    CD 0557              CALL    WRDDB   ;WRITE OUT DDB
   04B7    C3 21B4              JMP     READD   ;GO TEST THE DISK
                        
                        ;*****************************************************
                        ; WAIT FOR REBOOT SIGNAL. COME HERE FROM A SUBROUTINE
                        ; IF AN ERROR HAS OCCURED. ALLOW THE USER TO REBOOT
                        ; CP/M OR TO RESTART THE FORMAT PROGRAM.
                        ;*****************************************************
                        
   04BA    CD 1144      WTBOOT: CALL    MSGF
   04BD    0D0A                 .BYTE   CR,LF
   04BF    202020202020         .ASCIS  \                  type   Q  to  quit or R to restart the program \
   0500    21 14D6              LXI     H,CCOK
   0503    CD 1150              CALL    GETOK   ;WAIT FOR INPUT
   0506    C3 0100              JMP     FORMAT  ;ELSE RESTART THE PROGRAM
                        
                        
                        ; FORMAT A GROUP OF TRACKS. THESE MAY BE THE SYSTEM
                        ; TRACKS OR THE USER TRACKS.
                        
   0509    3A 1F83      SUFORM: LDA     TRAKK   ;GET CURRENT TRACK NUMBER
   050C    4F                   MOV     C,A
   050D    0600                 MVI     B,0     ;UPDATE IMAGE TO SIDE 0
   050F    CD 0EF2              CALL    UTRACK  ;UPDATE IMAGE TO CURRENT TRACK
   0512    AF                   XRA     A
   0513    32 1137              STA     RVSIDE
   0516    CD 0FAD              CALL    FTRACK  ;FORMAT SIDE 0
                        
                        ;       LDA     SDSAV
                        
   0519    3A 1F7C              LDA     SDFORM
                        
   051C    FE53                 CPI     'S'     ;SINGLE SIDED DISK
   051E    CA 0545              JZ      SSID    ;YES
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 11




   0521    3A 1F83              LDA     TRAKK   ;UPDATE IMAGE TO SIDE 1
   0524    4F                   MOV     C,A
   0525    0601                 MVI     B,1
   0527    CD 0EF2              CALL    UTRACK
                        
   052A    3A 1F81              LDA     Z3SBYT  ;UPDATE Z3S BYTE TO SIDE 1
   052D    EE10                 XRI     1<DBSIDE
   052F    C3 0532              JMP     SBYT01
                        
   0532                 SBYT01:
   0532    32 1F81              STA     Z3SBYT
   0535    3E01                 MVI     A,1
   0537    32 1137              STA     RVSIDE
                        
   053A    CD 0FAD              CALL    FTRACK
                        
   053D    3A 1F81              LDA     Z3SBYT  ;RESTORE Z3S BYTE TO SIDE 0
   0540    EE10                 XRI     1<DBSIDE
                        
   0542                 SBYT02:
   0542    32 1F81              STA     Z3SBYT
                        
   0545    3A 1F83      SSID:   LDA     TRAKK   ;UPDATE CURRENT TRACK NUMBER
   0548    3C                   INR     A
   0549    32 1F83              STA     TRAKK
   054C    3D                   DCR     A
   054D    21 1F84              LXI     H,MAXTRK ;DID WE JUST DO THE MAX TRACK
   0550    BE                   CMP     M
   0551    C8                   RZ              ;YES, ALL DONE
   0552    CD 0F03              CALL    STEPIN  ;MOVE DRIVE TO MEXT TRACK
   0555    18B2                 JMPR    SUFORM  ;CONTINUE
                        
                        
                        ; WRITE OUT THE DDB IN THE LAST 128 BYTES OF
                        ; SIDE 0, TRACK 0, SECTOR 8.
                        
   0557    11 23DE      WRDDB:  LXI     D,TBEGIN+1 ;SET UP FOR FILL CHARACTER
   055A    21 23DD              LXI     H,TBEGIN
   055D    01 0180              LXI     B,512-128
   0560    36E5                 MVI     M,0E5H
   0562    EDB0                 LDIR            ;MOVE FILL CHAR INTO SECTOR
   0564    01 007F              LXI     B,128-1
   0567    3600                 MVI     M,0
   0569    EDB0                 LDIR            ;CLEAR WHERE DDB WILL GO
                        
   056B    11 255D              LXI     D,TBEGIN+512-128 ;PUT THE DDB HERE
   056E    21 1F8A              LXI     H,DTABLE
   0571    3A 1FB0              LDA     DDBLOC  ;GET DDB LOCATION INTO HL
   0574    4F                   MOV     C,A
   0575    0600                 MVI     B,0
   0577    09                   DAD     B
   0578    3A 1FAF              LDA     DDBLEN  ;GET THE DDB LENGTH INTO BC
   057B    4F                   MOV     C,A
   057C    EDB0                 LDIR            ;MOVE IN THE DEFAULT DDB
   057E    3A 1F7A              LDA     SDSAV   ;SEE IF SINGLE SIDED DISK






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 12




   0581    FE53                 CPI     'S'
   0583    280E                 JRZ     ..SING  ;YES, DEFAULT DDB IS OKAY
                        
   0585    11 255D              LXI     D,TBEGIN+512-128 ;ALTERNATE DDB HERE
   0588    21 1FB1              LXI     H,ALTDDB ;ALT DDB LOCATION INTO HL
   058B    3A 1FAE              LDA     ALTLEN  ;LENGTH OF ALT DDB INTO BC
   058E    4F                   MOV     C,A
   058F    0600                 MVI     B,0
   0591    EDB0                 LDIR            ;MOVE IN THE ALTERNATE DDB
                        
   0593                 ..SING:
                        
                        
   0593    AF                   XRA     A       ;SET FDC TO TRACK 0
   0594    D355                 OUT     WTRACK
   0596    3E08                 MVI     A,8     ;AND TO SECTOR 8
   0598    D356                 OUT     WSECT
   059A    21 23DD              LXI     H,TBEGIN ;SET START ADDRESS
   059D    01 0057              LXI     B,0<8+WDATA ;SET COUNT AND PORT
                        
                        
   05A0    3A 1F81              LDA     Z3SBYT  ;SET HARDWARE DATA WAIT
   05A3    EE80                 XRI     1<DBWAIT
   05A5                 DCMD01:
   05A5    D353                 OUT     DCMD
   05A7    3EA0                 MVI     A,WWRIT
   05A9    D354                 OUT     WCMD
   05AB    EDB3                 OUTIR           ;WRITE THE SECTOR
   05AD    EDB3                 OUTIR
   05AF    3A 1F81              LDA     Z3SBYT  ;RESET HARDWARE DATA WAIT
   05B2    D353                 OUT     DCMD
   05B4                 SWFIN:
   05B4    CD 1138              CALL    FDONEF  ;CHECK FOR SUCCESSFUL WRITE
   05B7    E6FC                 ANI     WSWRIT
   05B9    2005                 JRNZ    ..BAD   ;UNSUCCESSFUL
   05BB    0600                 MVI     B,0
   05BD    10FE                 DJNZ    .       ;WAIT FOR TRIM ERASE TO END
   05BF    C9                   RET
                        
   05C0    CD 1144      ..BAD:  CALL    MSGF
   05C3    0A0A0D0A             .BYTE   LF,LF,CR,LF
   05C7    202020202020         .ASCIS  \                               write sector error \
   05F9    C3 20E3              JMP     ASKFOR
                        
                        ;******************************************************
                        ; QUESTION THE USER TO DETERMINE THE DESIRED FORMATTING
                        ; OPTIONS.
                        ;******************************************************
                        
   05FC                 QUEST:
   05FC                 GETSYS:
   05FC    CD 1144              CALL    MSGF
                        
   05FF    0D0A0A               .BYTE   CR,LF,LF
   0602    57696C6C2064         .ASCIS  \Will disk be V2BIOS compatible or Standard format ('V','S') :\






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 13




   063F    21 14E3              LXI     H,STDSYS
   0642    CD 1150              CALL    GETOK
   0645    32 1F7B              STA     STDSAV
                        
   0648    CD 1144              CALL    MSGF    ;GET NUMBER OF TRACKS TO FORMAT
   064B    0D0A0D0A             .BYTE   CR,LF,CR,LF
   064F    666F726D6174         .ASCII  \format all tracks or format\
   066A    207379737465         .ASCIS  \ system tracks only (A,S): \
   0685    21 14AE              LXI     H,TROK  ;POINT TO OK RESPONSES
   0688    CD 1150              CALL    GETOK   ;GET AN OKAY CHARACTER
   068B    32 1F75              STA     TRSAV
   068E    CD 1144              CALL    MSGF    ;GET SIZE OF DISK
   0691    0D0A                 .BYTE   CR,LF
   0693    3520696E6368         .ASCII  \5 inch disk or 8 inch disk \
   06AE    28352C38293A         .ASCIS  \(5,8): \
   06B5    21 14B2              LXI     H,SIOK
   06B8    CD 1150              CALL    GETOK   ;GET SIZE
   06BB    32 1F76              STA     SISAV
   06BE    21 1F79              LXI     H,NESAV ;ASSUME STANDARD DRIVE
   06C1    3653                 MVI     M,'S'
                        
                        ;       CPI     '5'     ;MINI IF SO MAY BE WANGCO
                        ;       JRNZ    ..EIG   ;NOPE
                        ;       CALL    MSGF    ;GET NUMBER OF TRACKS
                        ;       .BYTE   CR,LF
                        ;       .ASCII  \standard drive or extended \
                        ;       .ASCIS  \track drive (S,E): \
                        ;       LXI     H,NEOK
                        ;       CALL    GETOK
                        ;       STA     NESAV
                        
   06C3    CD 1144      ..EIG:  CALL    MSGF    ;GET NUMBER OF SIDES
   06C6    0D0A                 .BYTE   CR,LF
   06C8    73696E676C65         .ASCII  \single sided disk or double \
   06E4    736964656420         .ASCIS  \sided disk (S,D): \
   06F6    21 14CA              LXI     H,SDOK
   06F9    CD 1150              CALL    GETOK
   06FC    32 1F7A              STA     SDSAV
                                
   06FF    CD 1144              CALL    MSGF    ;GET RECORDING DENSITY
   0702    0D0A                 .BYTE   CR,LF
   0704    73696E676C65         .ASCII  \single density disk or double \
   0722    64656E736974         .ASCIS  \density disk (S,D): \
   0736    21 14B6              LXI     H,DEOK
   0739    CD 1150              CALL    GETOK   ;GET DENSITY
   073C    32 1F77              STA     DESAV
   073F                 ..TEN:
                        
   073F    3A 1F76              LDA     SISAV   ;CHECK SIZE AGAIN
   0742    FE38                 CPI     '8'
   0744    CA 0794              JZ      ..IS8
                        
   0747    CD 1144              CALL    MSGF    ;GET SECTOR SIZE 
   074A    0D0A                 .BYTE   CR,LF
   074C    736563746F72         .ASCII  \sector size of 128 (1) , 256 (2), \






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 14




   076E    6F7220353132         .ASCIS  \or 512 (3) bytes (1,2,3): \
   0788    21 14C1              LXI     H,LEOK5
   078B    CD 1150              CALL    GETOK   ;GET SIZE
   078E    32 1F78              STA     LESAV
   0791    C3 0854              JMP     SKIPVF
                        
                        
   0794                 ..IS8:
   0794    CD 1144              CALL    MSGF    ;GET SECTOR SIZE 
   0797    0D0A                 .BYTE   CR,LF
   0799    736563746F72         .ASCII  \sector size of 128 (1) , 256 (2), \
   07BB    353132202833         .ASCIS  \512 (3) , or 1024 (4)  bytes (1,2,3,4): \
   07E3    21 14BB              LXI     H,LEOK
   07E6    CD 1150              CALL    GETOK   ;GET SIZE
   07E9    32 1F78              STA     LESAV
   07EC    FE34                 CPI     '4'
   07EE    C2 0854              JNZ     SKIPVF
   07F1    3A 1F77              LDA     DESAV
   07F4    FE53                 CPI     'S'
   07F6    CA 0854              JZ      SKIPVF
                        
   07F9    CD 1144              CALL    MSGF    ;GET SECTORS PER TRACK
   07FC    0D0A                 .BYTE   CR,LF
   07FE    736563746F72         .ASCII  \sectors per track 9 (1),10 (2),\
   081D    6F7220313120         .ASCIS  \or 11 (3) - 2 & 3 for 3.5" HD drives (1,2,3): \
   084B    21 14E7              LXI     H,MEGSOK
   084E    CD 1150              CALL    GETOK   ;GET SIZE
   0851    32 1F7D              STA     MEGSAV
                        
   0854                 SKIPVF:
   0854    CD 1144              CALL    MSGF    ;GET READ VERIFY
   0857    0D0A                 .BYTE   CR,LF
   0859    446F20612072         .ASCIS  \Do a read-verify during format (Y,N) \
   087E    21 14EC              LXI     H,VEROK
   0881    CD 1150              CALL    GETOK   ;GET SIZE
   0884    32 1F7F              STA     VERFON
                        
   0887    C9                   RET
                        
                        ;OLD CODE TO KEEP SECTOR SIZE AT 512 BYTES MAX
                        
   0888                 ..FTV:
   0888    CD 1144              CALL    MSGF
   088B    0D0A                 .BYTE   CR,LF
   088D    736563746F72         .ASCII  \sector size of  128 (1) , 256 (2), \
   08B0    6F7220353132         .ASCIS  \or 512 (3) bytes :\
   08C2    21 14BB              LXI     H,LEOK
   08C5    CD 1150              CALL    GETOK
   08C8    32 1F78              STA     LESAV
   08CB    FE34                 CPI     '4'
   08CD    D8                   RC              ;O.K.
   08CE    3E33                 MVI     A,'3'
   08D0    32 1F78              STA     LESAV
   08D3    C9                   RET
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 15




                        ;***************************************************
                        ; TELL THE USER THE OPTIONS HE SELECTED.
                        ;***************************************************
                        
                        
   08D4    CD 1144      TELL:   CALL    MSGF
   08D7    1A0D0A0D0A           .BYTE   CLEAR,CR,LF,CR,LF
   08DC    202020202020         .ASCII  \                               Selected Options: \
   090D    0D0A0A               .BYTE   CR,LF,LF
   0910    202020202020         .ASCIS  \                  \
   0922    3A 1F75              LDA     TRSAV   ;PRINT NUMBER TRACKS TO FORMAT
   0925    FE41                 CPI     'A'
   0927    2008                 JRNZ    ..TRSO
   0929    CD 1144              CALL    MSGF
   092C    616CEC               .ASCIS  \all\
   092F    180E                 JMPR    ..TR
   0931    CD 1144      ..TRSO: CALL    MSGF
   0934    6F6E6C792073         .ASCIS  \only system\
   093F    CD 1144      ..TR:   CALL    MSGF
   0942    20747261636B         .ASCIS  \ tracks will be formatted.\
                        
   095C    CD 1144              CALL    MSGF
   095F    0D0A                 .BYTE   CR,LF
   0961    202020202020         .ASCIS  \                  \
   0973    3A 1F76              LDA     SISAV   ;PRINT 5 INCH OR 8 INCH SIZE
   0976    FE35                 CPI     '5'
   0978    2006                 JRNZ    ..SI8
   097A    CD 1144              CALL    MSGF
   097D    B5                   .ASCIS  \5\
   097E    1804                 JMPR    ..SI
   0980    CD 1144      ..SI8:  CALL    MSGF
   0983    B8                   .ASCIS  \8\
   0984    CD 1144      ..SI:   CALL    MSGF
   0987    20696E636820         .ASCIS  \ inch disk. \
                        
   0993    3A 1F7A              LDA     SDSAV   ;PRINT SINGLE, DOUBLE SIDED
   0996    FE53                 CPI     'S'
   0998    2012                 JRNZ    ..SDD
   099A    CD 1144              CALL    MSGF
   099D    73696E676C65         .ASCIS  \single sided.\
   09AA    1810                 JMPR    ..SD
   09AC    CD 1144      ..SDD:  CALL    MSGF
   09AF    646F75626C65         .ASCIS  \double sided.\
                        
   09BC    3A 1F79      ..SD:   LDA     NESAV   ;PRINT IF EXTENDED TRACKS
   09BF    FE45                 CPI     'E'
   09C1    201E                 JRNZ    ..NE                    
   09C3    CD 1144              CALL    MSGF
   09C6    20657874656E         .ASCIS  \ extended number of tracks.\
                        
   09E1    CD 1144      ..NE:   CALL    MSGF
   09E4    0D0A                 .BYTE   CR,LF
   09E6    202020202020         .ASCIS  \                  \
   09F8    3A 1F77              LDA     DESAV   ;PRINT DENSITY
   09FB    FE53                 CPI     'S'






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 16




   09FD    200B                 JRNZ    ..DED
   09FF    CD 1144              CALL    MSGF
   0A02    73696E676CE5         .ASCIS  \single\
   0A08    1809                 JMPR    ..DE
   0A0A    CD 1144      ..DED:  CALL    MSGF
   0A0D    646F75626CE5         .ASCIS  \double\
   0A13    CD 1144      ..DE:   CALL    MSGF
   0A16    2064656E7369         .ASCIS  \ density. \
                        
   0A20    3A 1F78              LDA     LESAV   ;PRINT SECTOR LENGTH
   0A23    FE31                 CPI     '1'
   0A25    2008                 JRNZ    ..LE2
   0A27    CD 1144              CALL    MSGF
   0A2A    3132B8               .ASCIS  \128\
   0A2D    181F                 JMPR    ..LE
   0A2F    FE32         ..LE2:  CPI     '2'
   0A31    2008                 JRNZ    ..LE3
   0A33    CD 1144              CALL    MSGF
   0A36    3235B6               .ASCIS  \256\
   0A39    1813                 JMPR    ..LE
   0A3B    FE33         ..LE3:  CPI     '3'
   0A3D    2008                 JRNZ    ..LE4   
   0A3F    CD 1144              CALL    MSGF
   0A42    3531B2               .ASCIS  \512\
   0A45    1807                 JMPR    ..LE
   0A47                 ..LE4:
   0A47    CD 1144              CALL    MSGF
   0A4A    313032B4             .ASCIS  \1024\
   0A4E    CD 1144      ..LE:   CALL    MSGF
   0A51    206279746520         .ASCIS  \ byte sectors.\
   0A5F    3A 1F78              LDA     LESAV
   0A62    FE34                 CPI     '4'
   0A64    C2 0B31              JNZ     SEEVER
   0A67    3A 1F77              LDA     DESAV
   0A6A    FE53                 CPI     'S'
   0A6C    CA 0B31              JZ      SEEVER
                        
   0A6F    CD 1144              CALL    MSGF
   0A72    0D0A                 .BYTE   CR,LF
   0A74    202020202020         .ASCIS  \                  \
   0A86    3A 1F7D              LDA     MEGSAV
   0A89    FE31                 CPI     '1'
   0A8B    CA 0AC4              JZ      IS13M
   0A8E    FE32                 CPI     '2'
   0A90    CA 0B03              JZ      IS15M
   0A93    CD 1144              CALL    MSGF
   0A96    312E3636206D         .ASCIS  \1.66 mb = 11, 1K sectors, for 3.5" HD only.\
   0AC1    C3 0B31              JMP     SEEVER
   0AC4                 IS13M:
   0AC4    CD 1144              CALL    MSGF
   0AC7    312E33206D62         .ASCIS  \1.3 mb = 9, 1K sectors, for 3.5" & 5.25" HD or 8" drives.\
   0B00    C3 0B31              JMP     SEEVER
   0B03                 IS15M:
   0B03    CD 1144              CALL    MSGF
   0B06    312E3536206D         .ASCIS  \1.56 mb = 10, 1K sectors, for 3.5" HD only.\






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 17




   0B31                 SEEVER:
   0B31    3A 1F7F              LDA     VERFON
   0B34    FE4E                 CPI     'N'
   0B36    CA 0B6F              JZ      NOTVER
                        
   0B39    CD 1144              CALL    MSGF
   0B3C    0D0A                 .BYTE   CR,LF
   0B3E    202020202020         .ASCIS  \                  Read-after-write verification.\
   0B6E    C9                   RET
   0B6F                 NOTVER:
   0B6F    CD 1144              CALL    MSGF
   0B72    0D0A                 .BYTE   CR,LF
   0B74    202020202020         .ASCIS  \                  No read-after-write verification. \
   0BA8    C9                   RET
                        
                        ;*******************************************************
                        ; LOCATE THE DATA TABLE NEEDED FOR FORMATTING THE TRACK
                        ; AND MOVE IT TO ALLOW EASIER TO ACCESS THE FIELDS IN
                        ; THE TABLE.
                        ;*******************************************************
                        
   0BA9                 LTABLE:
   0BA9    3A 1F78              LDA     LESAV
   0BAC    FE34                 CPI     '4'
   0BAE    C2 0BE5              JNZ     NOT1K
   0BB1    3A 1F7D              LDA     MEGSAV
   0BB4    FE31                 CPI     '1'
   0BB6    CA 0BCC              JZ      SPT09
   0BB9    FE32                 CPI     '2'
   0BBB    CA 0BDA              JZ      SPT10
   0BBE    21 1EB5              LXI     H,TB11S
   0BC1    11 18FB              LXI     D,TB8D4
   0BC4    01 00BF              LXI     B,LEN11S
   0BC7    EDB0                 LDIR
   0BC9    C3 0BE5              JMP     NOT1K
   0BCC                 SPT09:
   0BCC    21 1D4F              LXI     H,TB09S
   0BCF    11 18FB              LXI     D,TB8D4
   0BD2    01 00AF              LXI     B,LEN09S
   0BD5    EDB0                 LDIR
   0BD7    C3 0BE5              JMP     NOT1K
   0BDA                 SPT10:
   0BDA    21 1DFE              LXI     H,TB10S
   0BDD    11 18FB              LXI     D,TB8D4
   0BE0    01 00B7              LXI     B,LEN10S
   0BE3    EDB0                 LDIR
   0BE5                 NOT1K:
                        
                        ; LTABLE USED TO START HERE
                        
   0BE5    21 14F4              LXI     H,TB    ;BEGINNING OF TABLES
   0BE8    DD21 1F87            LXI     X,CREATE ;DESIRED ENTRY
                                
   0BEC    E5           ..LOOP: PUSH    H       ;PLACE NEXT ENTRY IN INDEX REG
   0BED    FDE1                 POP     Y






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 18




                        
   0BEF    FD7E00               MOV     A,0(Y)  ;GET FIRST CHARACTER
   0BF2    B7                   ORA     A       ;END OF TABLE
   0BF3    2027                 JRNZ    ..MORE  ;NO
                        
   0BF5    CD 1144              CALL    MSGF
   0BF8    0D0A07               .BYTE   CR,LF,BELL
   0BFB    746869732066         .ASCIS  \this format not yet available.\
   0C19    C3 21B4              JMP     GOBAK   ;QUIT
                        
   0C1C    FD4E03       ..MORE: MOV     C,3(Y)  ;GET ENTRY LENGTH
   0C1F    0600                 MVI     B,0
                                
   0C21    DDBE00               CMP     0(X)    ;MATCH FIRST CHAR
   0C24    2010                 JRNZ    ..NOPE
   0C26    FD7E01               MOV     A,1(Y)  ;MATCH NEXT CHAR
   0C29    DDBE01               CMP     1(X)
   0C2C    2008                 JRNZ    ..NOPE
   0C2E    FD7E02               MOV     A,2(Y)  ;MATCH LAST CHAR
   0C31    DDBE02               CMP     2(X)
   0C34    2803                 JRZ     ..YUP   ;GOT IT
                        
   0C36    09           ..NOPE: DAD     B       ;NO MATCH, TRY NEXT ENTRY
   0C37    18B3                 JMPR    ..LOOP
                        
   0C39    11 1F8A      ..YUP:  LXI     D,DTABLE ;GET DESTINATION ADDR
   0C3C    EDB0                 LDIR            ;MOVE DATA INTO FIXED TABLE
                        
                        ;WILL WE OVER-WRITE BDOS? BETTER CHECK
                        ;GET NUMBER OF SECTORS, AND ADD 50% FOR
                        ;INTER-RECORD OVERHEAD AND TRAILING BYTES
                        
   0C3E    3A 1F99              LDA     RPTCNT  ;GET NUMER OF SECTORS
   0C41    37                   STC
   0C42    3F                   CMC
   0C43    1F                   RAR             ;#/2, 50% OVERHEAD IS TYPICAL
   0C44    37                   STC
   0C45    3F                   CMC
   0C46    1F                   RAR             ;#/4, FOR 25% OVERHEAD
                        
   0C47    21 1F99              LXI     H,RPTCNT
   0C4A    86                   ADD     M
   0C4B    47                   MOV     B,A     ;SAVE FOR LATER CALCULATION
   0C4C    11 0400              LXI     D,1024  ;COULD BE 1024 BYTE SECTOR
   0C4F    3A 1F9F              LDA     LENV    ;GET ACTUAL SECTOR LENGTH FLAG
   0C52    32 23CC              STA     SECSZ
   0C55    FE00                 CPI     0
   0C57    CA 0C67              JZ      LEN128
   0C5A    FE01                 CPI     1
   0C5C    CA 0C6D              JZ      LEN256
   0C5F    FE02                 CPI     2
   0C61    CA 0C73              JZ      LEN512
   0C64    C3 0C76              JMP     DOBSIZ  ;GO CALCULATE BUFFER SIZE
   0C67                 LEN128:
   0C67    11 0080              LXI     D,128






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 19




   0C6A    C3 0C76              JMP     DOBSIZ
   0C6D                 LEN256:
   0C6D    11 0100              LXI     D,256
   0C70    C3 0C76              JMP     DOBSIZ
   0C73                 LEN512:
   0C73    11 0200              LXI     D,512
   0C76                 DOBSIZ:
   0C76    21 23DD              LXI     H,TBEGIN        ;WHERE TRACK IMAGE WILL GO
   0C79                 SIZUP:
   0C79    19                   DAD     D
   0C7A    05                   DCR     B
   0C7B    C2 0C79              JNZ     SIZUP
   0C7E    22 23C5              SHLD    SECCOM
   0C81    4C                   MOV     C,H             ;SAVE THE PAGE VALUE
   0C82    3A 0007              LDA     BDOS+2          ;GET BDOS PAGE
   0C85    32 23D3              STA     BDSIZ
   0C88    37                   STC
   0C89    3F                   CMC
   0C8A    B9                   CMP     C
   0C8B    F5                   PUSH    PSW
   0C8C    E1                   POP     H
   0C8D    22 23DB              SHLD    PSWSAV
   0C90    DA 0C97              JC      ISOUCH
   0C93    CA 0C97              JZ      ISOUCH
   0C96    C9                   RET
                        
   0C97                 ISOUCH:
   0C97    CD 1144              CALL    MSGF
   0C9A    0D0A070A07           .BYTE   CR,LF,BELL,LF,BELL
   0C9F    202020202020         .ASCII  \                                ! ! WARNING ! !\
   0CCE    0D0A0A               .BYTE   CR,LF,LF
   0CD1    202020202020         .ASCII  \                    This format image will overwrite BDOS\
   0D0A    0D0A0A               .BYTE   CR,LF,LF
   0D0D    202020202050         .ASCIS  \     Press any key to return to Menu and try a smaller format, or Quit\
                        
   0D53    CD 1178              CALL    CI      ;GET ANY KEY
                        
   0D56    C3 21B4              JMP     GOBAK   ;QUIT
                        
                        ;       RET
                        
                        ;******************************************************
                        ; CREATE A PROTOTYPE TRACK IMAGE IN MEMORY. THIS IMAGE,
                        ; SUITABLY UPDATED WITH THE CORRECT TRACK NUMBER AND
                        ; SIDE NUMBER, IS THE EXACT SEQUENCE OF BYTES WHICH
                        ; WILL BE SENT TO THE WDC 179X CHIP WHEN FORMATTING A
                        ; TRACK. CREATE THE TABLE TRTAB TO ALLOW CHANGING THE
                        ; HEAD NUMBER AND TRACK NUMBER BYTES WITHOUT REDOING
                        ; THE ENTIRE MEMORY IMAGE.
                        ;******************************************************
                        
   0D59    01 0063      CTRAKK: LXI     B,TRLEN-1 ;CLEAR TRACK ADDRESS TABLE
   0D5C    11 2072              LXI     D,TRTAB+1
   0D5F    21 2071              LXI     H,TRTAB
   0D62    3600                 MVI     M,0






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 20




   0D64    EDB0                 LDIR
                        
   0D66    DD21 2071            LXI     X,TRTAB ;POINT TO TRACK ADDRESS TABLE
   0D6A    21 23DD              LXI     H,TBEGIN ;START GENERATING TRACK HERE
                        ][      .SALL
                        ]
                                RB      [G4A]   ;GAP 4 A[
   0D6D    3A 1F8F     +        LDA     G4AL    ;GET LENGTH
   0D70    B7          +        ORA     A
   0D71    280C        +        JRZ     ..0001  ;EXIT IF NULL
   0D73    4F          +        MOV     C,A
   0D74    0600        +        MVI     B,0
   0D76    54          +        MOV     D,H
   0D77    5D          +        MOV     E,L
   0D78    13          +        INX     D
   0D79    3A 1F90     +        LDA     G4AV    ;GET VALUE
   0D7C    77          +        MOV     M,A
   0D7D    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0D7F                +..0001:]
                                RB      [INSYA] ;INDEX SYNC PATTERNS[
   0D7F    3A 1F91     +        LDA     INSYAL  ;GET LENGTH
   0D82    B7          +        ORA     A
   0D83    280C        +        JRZ     ..0002  ;EXIT IF NULL
   0D85    4F          +        MOV     C,A
   0D86    0600        +        MVI     B,0
   0D88    54          +        MOV     D,H
   0D89    5D          +        MOV     E,L
   0D8A    13          +        INX     D
   0D8B    3A 1F92     +        LDA     INSYAV  ;GET VALUE
   0D8E    77          +        MOV     M,A
   0D8F    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0D91                +..0002:]
                                RB      [INSYB][
   0D91    3A 1F93     +        LDA     INSYBL  ;GET LENGTH
   0D94    B7          +        ORA     A
   0D95    280C        +        JRZ     ..0003  ;EXIT IF NULL
   0D97    4F          +        MOV     C,A
   0D98    0600        +        MVI     B,0
   0D9A    54          +        MOV     D,H
   0D9B    5D          +        MOV     E,L
   0D9C    13          +        INX     D
   0D9D    3A 1F94     +        LDA     INSYBV  ;GET VALUE
   0DA0    77          +        MOV     M,A
   0DA1    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0DA3                +..0003:]
                                RB      [INAM]  ;INDEX AM[
   0DA3    3A 1F95     +        LDA     INAML   ;GET LENGTH
   0DA6    B7          +        ORA     A
   0DA7    280C        +        JRZ     ..0004  ;EXIT IF NULL
   0DA9    4F          +        MOV     C,A
   0DAA    0600        +        MVI     B,0
   0DAC    54          +        MOV     D,H
   0DAD    5D          +        MOV     E,L
   0DAE    13          +        INX     D
   0DAF    3A 1F96     +        LDA     INAMV   ;GET VALUE






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 21




   0DB2    77          +        MOV     M,A
   0DB3    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0DB5                +..0004:]
                                RB      [G1]    ;GAP 1[
   0DB5    3A 1F97     +        LDA     G1L     ;GET LENGTH
   0DB8    B7          +        ORA     A
   0DB9    280C        +        JRZ     ..0005  ;EXIT IF NULL
   0DBB    4F          +        MOV     C,A
   0DBC    0600        +        MVI     B,0
   0DBE    54          +        MOV     D,H
   0DBF    5D          +        MOV     E,L
   0DC0    13          +        INX     D
   0DC1    3A 1F98     +        LDA     G1V     ;GET VALUE
   0DC4    77          +        MOV     M,A
   0DC5    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0DC7                +..0005:]
                        
   0DC7    3A 1F99              LDA     RPTCNT  ;GET REPEAT COUNT
   0DCA    32 1F86              STA     REPEAT  ;SAVE IT
   0DCD    3E01                 MVI     A,1     ;INITIALIZE SECTOR COUNT
   0DCF    32 1F85              STA     SECTOR  
                        
   0DD2                 ..SECT: RB      [IDSYA] ;ID SYNC PATTERNS[
   0DD2    3A 1F9A     +        LDA     IDSYAL  ;GET LENGTH
   0DD5    B7          +        ORA     A
   0DD6    280C        +        JRZ     ..0006  ;EXIT IF NULL
   0DD8    4F          +        MOV     C,A
   0DD9    0600        +        MVI     B,0
   0DDB    54          +        MOV     D,H
   0DDC    5D          +        MOV     E,L
   0DDD    13          +        INX     D
   0DDE    3A 1F9B     +        LDA     IDSYAV  ;GET VALUE
   0DE1    77          +        MOV     M,A
   0DE2    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0DE4                +..0006:]
                                RB      [IDSYB][
   0DE4    3A 1F9C     +        LDA     IDSYBL  ;GET LENGTH
   0DE7    B7          +        ORA     A
   0DE8    280C        +        JRZ     ..0007  ;EXIT IF NULL
   0DEA    4F          +        MOV     C,A
   0DEB    0600        +        MVI     B,0
   0DED    54          +        MOV     D,H
   0DEE    5D          +        MOV     E,L
   0DEF    13          +        INX     D
   0DF0    3A 1F9D     +        LDA     IDSYBV  ;GET VALUE
   0DF3    77          +        MOV     M,A
   0DF4    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0DF6                +..0007:]
   0DF6    36FE                 MVI     M,0FEH  ;ID AM
   0DF8    23                   INX     H
                        
   0DF9    DD7500               MOV     0(X),L  ;SAVE TRACK, SIDE ADDRESS
   0DFC    DD23                 INX     X
   0DFE    DD7400               MOV     0(X),H
   0E01    DD23                 INX     X






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 22




                        
   0E03    3600                 MVI     M,0H    ;GENERATE TRACK NUMBER
   0E05    23                   INX     H
   0E06    3600                 MVI     M,0H    ;GENERATE SIDE NUMBER
   0E08    23                   INX     H               
   0E09    3A 1F85              LDA     SECTOR  ;GENERATE PROPER SECTOR
   0E0C    77                   MOV     M,A
   0E0D    23                   INX     H
   0E0E    3C                   INR     A       ;UPDATE SECTOR COUNT
   0E0F    32 1F85              STA     SECTOR
                        
                                RB      [LEN]   ;SECTOR LENGTH BYTE[
   0E12    3A 1F9E     +        LDA     LENL    ;GET LENGTH
   0E15    B7          +        ORA     A
   0E16    280C        +        JRZ     ..0008  ;EXIT IF NULL
   0E18    4F          +        MOV     C,A
   0E19    0600        +        MVI     B,0
   0E1B    54          +        MOV     D,H
   0E1C    5D          +        MOV     E,L
   0E1D    13          +        INX     D
   0E1E    3A 1F9F     +        LDA     LENV    ;GET VALUE
   0E21    77          +        MOV     M,A
   0E22    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0E24                +..0008:]
   0E24    36F7                 MVI     M,0F7H  ;ID CRC
   0E26    23                   INX     H
                                RB      [G2]    ;GAP 2[
   0E27    3A 1FA0     +        LDA     G2L     ;GET LENGTH
   0E2A    B7          +        ORA     A
   0E2B    280C        +        JRZ     ..0009  ;EXIT IF NULL
   0E2D    4F          +        MOV     C,A
   0E2E    0600        +        MVI     B,0
   0E30    54          +        MOV     D,H
   0E31    5D          +        MOV     E,L
   0E32    13          +        INX     D
   0E33    3A 1FA1     +        LDA     G2V     ;GET VALUE
   0E36    77          +        MOV     M,A
   0E37    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0E39                +..0009:]
                                RB      [DASYA] ;DATA SYNC PATTERNS[
   0E39    3A 1FA2     +        LDA     DASYAL  ;GET LENGTH
   0E3C    B7          +        ORA     A
   0E3D    280C        +        JRZ     ..0010  ;EXIT IF NULL
   0E3F    4F          +        MOV     C,A
   0E40    0600        +        MVI     B,0
   0E42    54          +        MOV     D,H
   0E43    5D          +        MOV     E,L
   0E44    13          +        INX     D
   0E45    3A 1FA3     +        LDA     DASYAV  ;GET VALUE
   0E48    77          +        MOV     M,A
   0E49    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0E4B                +..0010:]
                                RB      [DASYB][
   0E4B    3A 1FA4     +        LDA     DASYBL  ;GET LENGTH
   0E4E    B7          +        ORA     A






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 23




   0E4F    280C        +        JRZ     ..0011  ;EXIT IF NULL
   0E51    4F          +        MOV     C,A
   0E52    0600        +        MVI     B,0
   0E54    54          +        MOV     D,H
   0E55    5D          +        MOV     E,L
   0E56    13          +        INX     D
   0E57    3A 1FA5     +        LDA     DASYBV  ;GET VALUE
   0E5A    77          +        MOV     M,A
   0E5B    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0E5D                +..0011:]
   0E5D    36FB                 MVI     M,0FBH  ;DATA AM
   0E5F    23                   INX     H
                                RW      [DACNT][
   0E60    ED4B 1FA6   +        LBCD    DACNTL  ;GET LENGTH
   0E64    78          +        MOV     A,B
   0E65    B1          +        ORA     C
   0E66    2809        +        JRZ     ..0012  ;EXIT IF NULL
   0E68    54          +        MOV     D,H
   0E69    5D          +        MOV     E,L
   0E6A    13          +        INX     D
   0E6B    3A 1FA8     +        LDA     DACNTV  ;GET VALUE
   0E6E    77          +        MOV     M,A
   0E6F    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0E71                +..0012:]
   0E71    36F7                 MVI     M,0F7H  ;DATA CRC
   0E73    23                   INX     H
                                RB      [G3]    ;GAP 3[
   0E74    3A 1FA9     +        LDA     G3L     ;GET LENGTH
   0E77    B7          +        ORA     A
   0E78    280C        +        JRZ     ..0013  ;EXIT IF NULL
   0E7A    4F          +        MOV     C,A
   0E7B    0600        +        MVI     B,0
   0E7D    54          +        MOV     D,H
   0E7E    5D          +        MOV     E,L
   0E7F    13          +        INX     D
   0E80    3A 1FAA     +        LDA     G3V     ;GET VALUE
   0E83    77          +        MOV     M,A
   0E84    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0E86                +..0013:]
                        
   0E86    3A 1F86              LDA     REPEAT  ;TEST IF ALL SECTORS DONE
   0E89    3D                   DCR     A
   0E8A    32 1F86              STA     REPEAT
   0E8D    C2 0DD2              JNZ     ..SECT  ;NO, DO NEXT SECTOR
                        
                                RW      [G4B]   ;GAP 4 B[
   0E90    ED4B 1FAB   +        LBCD    G4BL    ;GET LENGTH
   0E94    78          +        MOV     A,B
   0E95    B1          +        ORA     C
   0E96    2809        +        JRZ     ..0014  ;EXIT IF NULL
   0E98    54          +        MOV     D,H
   0E99    5D          +        MOV     E,L
   0E9A    13          +        INX     D
   0E9B    3A 1FAD     +        LDA     G4BV    ;GET VALUE
   0E9E    77          +        MOV     M,A






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 24




   0E9F    EDB0        +        LDIR            ;GENERATE NEXT PATTERN
   0EA1                +..0014:]
   0EA1    23                   INX     H
   0EA2    22 23A3              SHLD    FINAL   ;SAVE FIRST FREE ADDRESS
   0EA5    3A 0007              LDA     BDOS+2  ;GET BDOS PAGE
   0EA8    32 23B4              STA     CHKFLG
   0EAB    37                   STC
   0EAC    3F                   CMC
   0EAD    BC                   CMP     H       ;TEST WITH TABLE
   0EAE    D2 0EB2              JNC     CHEKBF
   0EB1    76                   HLT             ;OUCH. WE KILLED BDOS
                        
   0EB2                 CHEKBF:
   0EB2    3A 1F99              LDA     RPTCNT  ;GET NUMBER OF SECTORS
   0EB5    47                   MOV     B,A
   0EB6    3A 1F78              LDA     LESAV   ;GET SECTOR SIZE
   0EB9    11 0080              LXI     D,128
   0EBC    FE31                 CPI     '1'
   0EBE    CA 0ED4              JZ      MUL00
   0EC1    11 0100              LXI     D,256
   0EC4    FE32                 CPI     '2'
   0EC6    CA 0ED4              JZ      MUL00
   0EC9    11 0200              LXI     D,512
   0ECC    FE33                 CPI     '3'
   0ECE    CA 0ED4              JZ      MUL00
   0ED1    11 0400              LXI     D,1024
                                
   0ED4                 MUL00:
   0ED4    21 0000              LXI     H,0
   0ED7                 MUL01:
   0ED7    19                   DAD     D
   0ED8    05                   DCR     B
   0ED9    C2 0ED7              JNZ     MUL01
   0EDC    E5                   PUSH    H
   0EDD    D1                   POP     D
   0EDE    2A 23A3              LHLD    FINAL
   0EE1    19                   DAD     D
   0EE2    22 23BC              SHLD    VERADD
   0EE5    37                   STC
   0EE6    3F                   CMC
   0EE7    3A 0007              LDA     BDOS+2  ;GET BDOS PAGE
   0EEA    BC                   CMP     H       ;COMPARE WITH LAST READ BUFFER LOC
   0EEB    D0                   RNC             ;WE HAVE ENOUGH RAM
   0EEC    3E4E                 MVI     A,'N'
   0EEE    32 1F7F              STA     VERFON  ;DO NOT DO READ VERIFICATION
                        
   0EF1    C9                   RET             ;ALL DONE
                        
                        ;****************************************************
                        ; UPDATE THE MEMORY IMAGE OF THE TRACK BY CHANGING
                        ; THE HEAD NUMBER AND TRACK NUMBER BYTES. USE TRTAB,
                        ; CREATED BY CTRAKK, TO GET THE LOCATION OF THESE
                        ; BYTES.
                        ;****************************************************
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 25




   0EF2    21 2071      UTRACK: LXI     H,TRTAB ;GET TRACK TABLE ADDRESS
                        
   0EF5    5E           ..LOOP: MOV     E,M     ;GET ADDRESS OF NEXT CHANGE
   0EF6    23                   INX     H
   0EF7    56                   MOV     D,M
   0EF8    23                   INX     H
   0EF9    7B                   MOV     A,E     ;ALL DONE
   0EFA    B2                   ORA     D
   0EFB    C8                   RZ              ;YES
   0EFC    EB                   XCHG
   0EFD    71                   MOV     M,C     ;CHANGE TRACK NUMBER
   0EFE    23                   INX     H
   0EFF    70                   MOV     M,B     ;CHANGE SIDE
   0F00    EB                   XCHG
   0F01    18F2                 JMPR    ..LOOP
                        
                        ;****************************************************
                        ;        STEP THE DISK DRIVE IN 1 TRACK.
                        ;****************************************************
                        
   0F03                 STEPIN:
   0F03    11 2291              LXI     D,TRFMES
   0F06    0E09                 MVI     C,PRINT
   0F08    CD 0005              CALL    BDOS
   0F0B    3A 1F83              LDA     TRAKK
   0F0E    4F                   MOV     C,A
   0F0F    CD 2266              CALL    DOHEX
                        
   0F12    3E5B                 MVI     A,WSTIN ;ISSUE STEP IN COMMAND
   0F14    D354                 OUT     WCMD
   0F16                 SDN:    
   0F16    CD 1138              CALL    FDONEF  ;WAIT FOR FDC DONE
   0F19    E69C                 ANI     WSSTIN  ;TEST STEP IN STATUS BITS
   0F1B    C8                   RZ              ;SUCCESSFUL
   0F1C    CD 1144              CALL    MSGF    ;UNSUCCESSFUL, PRINT MESSAGE
   0F1F    0A0A0D0A07           .BYTE   LF,LF,CR,LF,BELL
   0F24    202020202020         .ASCIS  \                                 step in error\
   0F52    C3 20E3              JMP     ASKFOR
                        
                        ;***************************************************
                        ;            HOME THE DISK DRIVE.
                        ;***************************************************
                        
   0F55    3E0B         HOMEF:  MVI     A,WHOMEF        ;ISSUE HOME COMMAND
   0F57    D354                 OUT     WCMD
   0F59    CD 1138              CALL    FDONEF  ;WAIT FOR 179X DONE
   0F5C    EE04                 XRI     1<WBTRK0 ;FLIP TRACK 0 BIT
   0F5E    E69C                 ANI     WSHOME  ;TEST HOME STATUS BITS
   0F60    C8                   RZ              ;SUCCESSFUL
   0F61    CD 1144              CALL    MSGF    ;UNSUCCESSFUL, PRINT MESSAGE
   0F64    0A0A0D0A07           .BYTE   LF,LF,CR,LF,BELL
   0F69    202020202020         .ASCIS  \                                  home error\
   0F95    C3 20E3              JMP     ASKFOR
                        
                        ;***************************************************






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 26




                        ; SELECT DESIRED DISK DRIVE. CREATE A VALID Z3S
                        ; CONTROL BYTE.
                        ;***************************************************
                        
   0F98                 SELECT:
                        
   0F98    3A 1F80              LDA     DRIVE
   0F9B    4F                   MOV     C,A     ;DESIRED DISK NUMBER
   0F9C    0600                 MVI     B,0
   0F9E    21 14AA              LXI     H,SELTAB ;POINT TO SELECT XLATE TABLE
   0FA1    09                   DAD     B       ;INDEX INTO IT
   0FA2    7E                   MOV     A,M     ;GET APPROPRIATE BYTE
                        
   0FA3    21 1F8E              LXI     H,DPROTO ;POINT TO Z3S CTRL PROTOTYPE
   0FA6    B6                   ORA     M       ;OR IN CONTROL WITH SELECT
   0FA7    32 1F81              STA     Z3SBYT  ;SAVE MERGED Z3S CONTROL BYTE
                        
   0FAA    D353                 OUT     DCMD    ;SELECT APPROPRIATE DISK DRIVE
   0FAC    C9                   RET
                        
                        ;******************************************************
                        ; WRITE OUT THE MEMORY IMAGE OF THE TRACK TO THE DISK.
                        ; THIS MEMORY IMAGE IS THE EXACT SEQUENCE OF BYTES
                        ; WHICH MUST BE SENT TO THE 179X CHIP TO CAUSE IT TO
                        ; CORRECTLY FORMAT THE CURRENT TRACK.
                        ;******************************************************
                        
   0FAD                 FTRACK:
   0FAD    21 23DD              LXI     H,TBEGIN ;POINT TO BYTES TO WRITE
   0FB0    01 0057              LXI     B,0<8+WDATA ;SET UP COUNT AND PORT
                        ;HERE WE TAKE MAX POSSIBLE BYTES
                        ;AND DIVIDE BY 256
                        ;       MVI     E,10417/256+3   ;OLD VALUE
                        
   0FB3    1E3B                 MVI     E,14400/256+3   ;SUPPORT UP TO 11 1024 BYTE SECTORS
   0FB5    3A 238B              LDA     Z3SFLG
   0FB8    3A 1F81              LDA     Z3SBYT  ;ACTIVATE HARDWARE DATA WAIT
   0FBB    EE80                 XRI     1<DBWAIT
   0FBD                 DCMD02:
   0FBD    D353                 OUT     DCMD
   0FBF    3EF4                 MVI     A,WWRTRK ;ISSUE WRITE TRACK COMMAND
   0FC1    D354                 OUT     WCMD
                        
   0FC3                 ..LOOP:
   0FC3    EDB3                 OUTIR           ;WRITE OUT EACH BYTE
   0FC5    1D                   DCR     E
   0FC6    C2 0FC3              JNZ     ..LOOP
                        
   0FC9    3A 1F81              LDA     Z3SBYT  ;DEACTIVATE HARDWARE DATA WAIT
   0FCC    D353                 OUT     DCMD
                        
   0FCE                 TKDN:
   0FCE    CD 1138              CALL    FDONEF  ;WAIT FOR FDC DONE
   0FD1    E6E4                 ANI     WSWRTR  ;SUCCESSFUL
   0FD3    C2 10C1              JNZ     WBAD    ;NOPE






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 27




   0FD6    0600                 MVI     B,0
   0FD8    10FE                 DJNZ    .       ;WAIT FOR TRIM ERASE TO END
   0FDA    3A 1F7F              LDA     VERFON
   0FDD    FE4E                 CPI     'N'
   0FDF    C8                   RZ
                        
   0FE0    11 22C0              LXI     D,TRVMES
   0FE3    0E09                 MVI     C,PRINT
   0FE5    CD 0005              CALL    BDOS
   0FE8    3A 1F83              LDA     TRAKK
   0FEB    4F                   MOV     C,A
   0FEC    CD 2266              CALL    DOHEX
                        
                        ;***********************************************************
                        ;NOW READ-VERIFY THE FORMATTED TRACK.
                        ;WE ISSUE A MULTI-SECTOR OPERATION TO SPEED THE TESTING,
                        ;BUT WE HAVE TO STOP THE OPERATION AFTER THE MAXIMUM NUMBER
                        ;OF PHYSICAL SECTORS FOR THIS TRACK HAVE BEEN READ.
                        ;THEN WE HAVE TO LOOK AT ANY ERRORS, AND DETERMINE IF
                        ;ANY BAD STATUS IS JUST AN END-OF-TRACK ERROR, OR AN
                        ;ACTUAL PHYSICAL PROBLEM.
                        ;THIS ROUTINE COULD BE MORE THOROUGH, BUT IT WORKED O.K.
                        ;IN ALL TESTS WITH DAMAGED MEDIA.
                        ;THIS IS JUST HOW THE WD179X FDC CHIP WORKS FOR MULTI-R/W
                        ;OPERATIONS.
                        ;***********************************************************
                        
                        ;FIRST RESET THE ERROR INFORMATION BUFFER, TO BE SURE
                        ;WE SEE NO FALSE VALUES FROM A PREVIOUS OPERATION
                        
   0FEF    21 FFFF              LXI     H,0FFFFH
   0FF2    22 2397              SHLD    FAILED
   0FF5    22 2399              SHLD    FAILED+2
   0FF8    22 239B              SHLD    FAILED+4
                        
                        ;UP TO 11K BYTES MUST BE READ IN TO THE READ BUFFER LOCATION
                        
   0FFB    2A 23A3              LHLD    FINAL   ;GET FREE BUFFER LOCATION
   0FFE    3A 1F99              LDA     RPTCNT  ;GET PHYSICAL SECTORS
   1001    32 239B              STA     FAILED+4        ;SAVE FOR LATER FAILURE DUMPS
   1004    5F                   MOV     E,A     ;E REG. WILL COUNT US THROUGH READ LOOP
   1005    0E57                 MVI     C,WDATA ;FDC DATA I/O PORT
                        
                        ; WE HAVE TO ALLOW FOR 128, 256, 512 & 1024 BYTE SECTORS
                        
   1007    0680                 MVI     B,128
   1009    3A 1F78              LDA     LESAV
   100C    FE31                 CPI     '1'
   100E    CA 1049              JZ      IS128
                        
                        ;IT IS NOT A 128 BYTE SECTOR, SO THE BYTE COUNTER IS SET TO 0 NOW
                        
   1011    0600                 MVI     B,0     ;BASIC COUNTER
   1013    FE32                 CPI     '2'     ;SEE IF 256 BYTE SECTOR
   1015    CA 103D              JZ      IS256   ;IF SO BRANCH






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 28




   1018    FE33                 CPI     '3'     ;SEE IF 512 BYTE SECTOR
   101A    CA 102F              JZ      IS512   ;IF SO BRANCH
                        
                        ; 1024 BYTE SECTORS HERE
                        
   101D                 IS1024:
   101D    CD 10A4              CALL    SETRED  ;SET THE FDC FOR A READ
   1020                 IS102:
   1020    EDB2                 INIR
   1022    EDB2                 INIR
   1024    EDB2                 INIR
   1026    EDB2                 INIR
   1028    1D                   DCR     E       ;UPDATE PHYSICAL SECTOR COUNT
   1029    C2 1020              JNZ     IS102
   102C    C3 1054              JMP     ENDRED  ;ALL DONE, GO CHECK IT
                        
                        ; 512 BYTE SECTORS HERE
                        
   102F                 IS512:          
   102F    CD 10A4              CALL    SETRED
   1032                 IS51:
                                ;MOV    A,C
                                ;STA ..0001
                                ;..0000: .BYTE 0DBH 
                                ;..0001: .BYTE 0
                                ;MOV M,A
                                ;INX H
                                ;DCR B
                                ;JNZ  ..0000
                                ;MOV    A,C
                                ;STA ..0003
                                ;..0002: .BYTE 0DBH 
                                ;..0003: .BYTE 0
                                ;MOV M,A
                                ;INX H
                                ;DCR B
                                ;JNZ  ..0002
   1032    EDB2                 INIR
   1034    EDB2                 INIR
   1036    1D                   DCR     E
   1037    C2 1032              JNZ     IS51
   103A    C3 1054              JMP     ENDRED
                        
                        ; 256 BYTE SECTORS HERE
                        
   103D                 IS256:
   103D    CD 10A4              CALL    SETRED
   1040                 IS25:
   1040    EDB2                 INIR
   1042    1D                   DCR     E
   1043    C2 1040              JNZ     IS25
   1046    C3 1054              JMP     ENDRED
                        
                        ; 128 BYTE SECTORS HERE
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 29




   1049                 IS128:
   1049    CD 10A4              CALL    SETRED
   104C                 IS12:
   104C    EDB2                 INIR
   104E    0680                 MVI     B,128
   1050    1D                   DCR     E
   1051    C2 104C              JNZ     IS12
                        
                        ; NOW TEST FOR RESULTS
                        
   1054                 ENDRED:
   1054    3A 1F81              LDA     Z3SBYT  ;DEACTIVATE HARDWARE DATA WAIT
   1057    D353                 OUT     DCMD
   1059    DB54                 IN      WSTAT   ;SAVE STATUS BEFORE FORCED-INTERRUPT
   105B    32 238A              STA     RSTAT
   105E    3ED0                 MVI     A,0D0H  ;FORCED-INTERRUPT = STOP OPERATION NOW
   1060    D354                 OUT     WCMD
   1062    3A 238A              LDA     RSTAT   ;CHECK PREVIOUS STATUS
   1065    E69C                 ANI     10011100B       ;MASK FOR POSSIBLE ERRORS
                        
   1067    C4 108A              CNZ     PRBAD   ;MAY BE BAD, MAY BE ACTUALLY O.K., GO CHECK
   106A    DA 10FC              JC      RBAD    ;IT WAS A REAL ERROR
                        
                        ;WAS IT MORE THAN A R.N.F. ?
                        
   106D    3A 238A              LDA     RSTAT
   1070    E68C                 ANI     10001100B       ;IGNORE R.N.F.
   1072    C2 10FC              JNZ     RBAD            ;IT LOOKS WORSE
                        
                        ; ELSE GET FINAL STATUS, WITH NO BUSY OPERATION, FOR SURE       
                        
   1075    CD 1138              CALL    FDONEF          ;NOW GET FINISHING STATUS
   1078    E69C                 ANI     10011100B
   107A    C8                   RZ                      ;NOTHING BAD HAPPENED
   107B    32 2397              STA     FAILED          ;LOOKS BAD
   107E    DB56                 IN      WSECT           ;GET SECTOR
   1080    47                   MOV     B,A             ;PUT IN B REG
   1081    3A 1F99              LDA     RPTCNT          ;GET MAXIMUM PHYSICAL SECTOR
   1084    B8                   CMP     B               ;CHECK IT
   1085    D2 10FC              JNC     RBAD            ;THAT LOOKS BAD ON NO-CY
   1088    AF                   XRA     A               ;GOOD ENOUGH!
   1089    C9                   RET
                        
                        ; THE READ FAILURE MAY BE O.K.
                        ; IT WILL ALWAYS GIVE A R.N.F. IN MULTI-SECTOR READS
                        ; SO WE COMPARE THE FAILED SECTOR WITH THE HIGHEST
                        ; SECTOR VALUE FOR THIS TRACK
                         
   108A                 PRBAD:
   108A    32 2397              STA     FAILED          ;SAVE FAILED STATUS
   108D    DB55                 IN      WTRACK          ;GET TRACK #
   108F    32 2399              STA     FAILED+2        ;SAVE IT
   1092    3A 1137              LDA     RVSIDE          ;GET SIDE VALUE 0 = LOWER, 1 = UPPER
   1095    32 239A              STA     FAILED+3        ;SAVE IT
   1098    DB56                 IN      WSECT           ;GET FAILED SECTOR






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 30




   109A    32 2398              STA     FAILED+1        ;SAVE IT
   109D    E5                   PUSH    H               ;SAVE DMA PLACE, COULD USE IT SOME DAY :)
   109E    21 1F99              LXI     H,RPTCNT        ;POINT TO PHYSICAL SECTORS PER TRACK
   10A1    BE                   CMP     M               ;COMPARE WITH FAILED SECTOR
   10A2    E1                   POP     H               ;RECOVER DMA
   10A3    C9                   RET                     ;GO BACK WITH FLAGS SET
                        
                        ; PREPARE THE FDC FOR MULTI-SECTOR READS
                        ; BE SURE TO SEND A PROPER READ COMMAND FOR READING
                        ; LOWER AND UPPER TRACKS.
                                
   10A4                 SETRED:
   10A4    3E01                 MVI     A,1     ;SECTOR 1
   10A6    D356                 OUT     WSECT
   10A8    3A 1F81              LDA     Z3SBYT  ;ACTIVATE HARDWARE DATA WAIT
   10AB    EE80                 XRI     1<DBWAIT
   10AD                 DCMD03:
   10AD    D353                 OUT     DCMD
   10AF    3A 1137              LDA     RVSIDE  ;SEE IF SIDE 0 OR 1
   10B2    FE00                 CPI     0
   10B4    C2 10BC              JNZ     ISAONE
   10B7    3E98                 MVI     A,98H ;ISSUE MULTI-SECTOR READ COMMAND, LOWER TRACK
   10B9    D354                 OUT     WCMD
   10BB    C9                   RET
   10BC                 ISAONE:
   10BC    3E9A                 MVI     A,9AH ;READ UPPER TRACK COMMAND, MULTI-SECTOR
   10BE    D354                 OUT     WCMD
   10C0    C9                   RET
                        
   10C1    CD 1144      WBAD:   CALL    MSGF
   10C4    0D0A0A0A07           .BYTE   CR,LF,LF,LF,BELL
   10C9    202020202020         .ASCIS  \                               write track error\
   10F9    C3 20E3              JMP     ASKFOR
                        
   10FC    CD 1144      RBAD:   CALL    MSGF
   10FF    0D0A0A0A07           .BYTE   CR,LF,LF,LF,BELL
   1104    202020202020         .ASCIS  \                               read verify error\
   1134    C3 20E3              JMP     ASKFOR
                        
   1137    00           RVSIDE: .BYTE   0
                        
                        ;***************************************************
                        ; WAIT FOR 179X DONE. RETURN STATUS WHEN DONE.
                        ;***************************************************
                        
   1138                 FDONEF:
   1138    3E28                 MVI     A,40    ;WAIT FOR VALID STATUS
   113A    3D           ..WAIT: DCR     A
   113B    20FD                 JRNZ    ..WAIT
                        
   113D                 ..DONE:
                        
   113D    DB54                 IN      WSTAT   ;GET STATUS
   113F    CB47                 BIT     WBBUSY,A ;BUSY
   1141    20FA                 JRNZ    ..DONE  ;YES, KEEP WAITING






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 31




                        
   1143    C9                   RET             ;RETURN STATUS
                        
                        ;***************************************************
                        ; OUTPUT AN INLINE MESSAGE TO THE CONSOLE.
                        ;***************************************************
                        
   1144    E3           MSGF:   XTHL            ;GET MESSAGE ADDRESS
                        
   1145    4E           ..LOOP: MOV     C,M     ;GET NEXT CHAR OF MESSAGE
   1146    23                   INX     H
   1147    CD 1184              CALL    CO      ;OUTPUT THE CHAR
   114A    B7                   ORA     A       ;LAST CHARACTER
   114B    F2 1145              JP      ..LOOP  ;NO
                        
   114E    E3                   XTHL            ;RESTORE NEW RETURN ADDRESS
   114F    C9                   RET
                        
                        ;****************************************************
                        ; GET A CHARACTER FROM THE CONSOLE. IF THE CHARACTER
                        ; IS UNACCEPTABLE, BEEP AND WAIT FOR ANOTHER. RETURN
                        ; TO CP/M IF ^C IS ENTERED. (BDOS DOES RETURN ON ^C)
                        ;****************************************************
                        ; THE CCIR Z80 INSTRUCTION CHECKS ALL ACCEPTABLE
                        ; CHARACTERS FROM THE TABLE POINTED TO BY HL
                        ; A BAD INPUT CAUSES A BELL, PLUS A BACKSPACE
                        ; BLANK-OVER AND BACKSPACE TO ERASE THE WRONG
                        ; INPUT ON CONSOLE, THEN THE ROUTINE IS RE-ENTERED
                        
   1150                 GETOK:  
   1150    E5           ..RTRY: PUSH    H       ;SAVE OK TABLE ADDR
   1151    4E                   MOV     C,M     ;GET COUNT
   1152    23                   INX     H
   1153    0600                 MVI     B,0
   1155    CD 1178              CALL    CI      ;GET A CHAR
   1158    FE51                 CPI     'Q'     ;IS IT QUIT 
   115A    CA 21B4              JZ      GOBAK   ;YES, GO BACK TO CP/M
   115D    EDB1                 CCIR            ;IS IT OKAY
   115F    E1                   POP     H
   1160    C8                   RZ              ;YES, RETURN IT
                        
   1161    0E07                 MVI     C,BELL  ;NO, RING BELL
   1163    CD 1184              CALL    CO
   1166    0E08                 MVI     C,8     ;BACK SPACE
   1168    CD 1184              CALL    CO
   116B    0E20                 MVI     C,' '
   116D    CD 1184              CALL    CO
   1170    0E08                 MVI     C,8
   1172    CD 1184              CALL    CO
   1175    C3 1150              JMP     ..RTRY  ;KEEP TRYING
                        
                        ;***************************************************
                        ;       GET A CHARACTER FROM THE CONSOLE.
                        ;***************************************************
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 32




   1178    C5           CI:     PUSH    B
   1179    D5                   PUSH    D
   117A    E5                   PUSH    H
   117B    0E01                 MVI     C,1     ;CONSOLE INPUT
   117D    CD 0005              CALL    BDOS    ;GET THE CHARACTER
   1180    E1                   POP     H
   1181    D1                   POP     D
   1182    C1                   POP     B
   1183    C9                   RET
                        
                        ;**************************************************
                        ;      WRITE A CHARACTER TO THE CONSOLE.
                        ;**************************************************
                        
   1184    C5           CO:     PUSH    B
   1185    D5                   PUSH    D
   1186    E5                   PUSH    H
   1187    79                   MOV     A,C
   1188    E67F                 ANI     7FH
   118A    5F                   MOV     E,A     ;MOVE CHARACTER TO E
   118B    0E02                 MVI     C,2     ;CONSOLE OUTPUT
   118D    CD 0005              CALL    BDOS    ;OUTPUT THE CHARACTER
   1190    E1                   POP     H
   1191    D1                   POP     D
   1192    C1                   POP     B
   1193    79                   MOV     A,C     ;FIX UP ACC
   1194    C9                   RET
                        
                        ;***************************************************
                        ;*    SAVE A MEMORY IMAGE OF NEW FORMAT OPTIONS
                        ;***************************************************
                        
   1195                 SAVEIT:
   0001                         GCON    ==      1       ;GET CONSOLE
   0002                         WCON    ==      2       ;OUTPUT CONSOLE
   0009                         PRINTS  ==      9       ;PRINT STRING
   000A                         GBUF    ==      10      ;GET CONSOLE BUFFER
   000F                         OPENF   ==      15      ;OPEN FILE
   0010                         CLOSEF  ==      16      ;CLOSE FILE
   0016                         MAKE    ==      22      ;MAKE FILE
   0011                         SEARCH  ==      17      ;SEARCH FOR MATCH
   0014                         READF   ==      20      ;READ FILE
   0015                         WRITEF  ==      21      ;WRITE FILE
   0013                         DELETE  ==      19      ;DELETE FILE
   001A                         DMAF    ==      26      ;SET DMA ADDRESS
                        
                        ;*********************************************************
                        ;*  INITIALIZE POSSIBLE FCB NAME AND RECORD WRITE COUNT 
                        ;*********************************************************
                        
   1195    31 0100              LXI     SP,100H         ;PUT HERE
   1198    AF                   XRA     A               ;CLEAR ACC
   1199    32 1471              STA     IDMALL          ;SET DMA BUFFER LOW
   119C    32 1473              STA     RECS            ;SET RECORDS TO XFER = 0
   119F    3C                   INR     A               ;ACC. = 1






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 33




   11A0    32 1472              STA     IDMALL+1        ;SET INITIAL DMA HIGH TO 01H
                        
                        ;**********************************************************
                        ;          CLEAR FCB IN CASE OF FILE RE-NAME
                        ;**********************************************************
                        
   11A3                 CLEARF:
   11A3    21 1487              LXI     H,FCBG+1        ;POINT TO NAME
   11A6    0608                 MVI     B,8             ;8 POSSIBLE CHARS
   11A8    3E20                 MVI     A,' '           ;A SPACE
   11AA    77           PAD:    MOV     M,A             ;FILL BYTE
   11AB    23                   INX     H
   11AC    05                   DCR     B
   11AD    20FB                 JRNZ    PAD
   11AF    AF                   XRA     A               ;PREPARE TO ZERO FCB FIELDS
   11B0    21 1493              LXI     H,FCBG+13       ;POINT TO CONTROL FIELDS
   11B3    0617                 MVI     B,36-13         ;GET LENGTH TO CLEAR
   11B5    77           PAD1:   MOV     M,A             ;FILL BYTE
   11B6    23                   INX     H
   11B7    05                   DCR     B
   11B8    20FB                 JRNZ    PAD1
                        
   11BA                 SAVSYS:
   11BA    0E09         GO0:    MVI     C,PRINTS        ;TELL USER WE WANT FILE NAME INFO
   11BC    11 12A8              LXI     D,MESS5         
   11BF    CD 0005              CALL    BDOS
   11C2    11 1474      SINP:   LXI     D,INBUFF        ;POINT TO NAME BUFFER
   11C5    0E0A                 MVI     C,GBUF          ;LOAD READ BUFFER FUNCTION
   11C7    CD 0005              CALL    BDOS
                        
                                
   11CA                 UPCASE:
   11CA    21 1476              LXI     H,INBUFF+2      ;POINT TO NAME IN BUFFER
   11CD    0608                 MVI     B,8             ;GET 8 CHARACTERS
   11CF    7E           NXTCHR: MOV     A,M
   11D0    FE20                 CPI     20H             ;SEE IF SPACE
   11D2    280A                 JRZ     NOUP            ;IF SO LEAVE AS IS
   11D4    FE30                 CPI     30H             ;TEST INVALID CHARACTER
   11D6    38E2                 JRC     GO0             ;WE DON'T WANT THIS NAME
   11D8    FE40                 CPI     40H
   11DA    3802                 JRC     NOUP
   11DC    E6DF                 ANI     0DFH            ;MAKE UPPER CASE
   11DE    77           NOUP:   MOV     M,A
   11DF    23                   INX     H
   11E0    05                   DCR     B
   11E1    20EC                 JRNZ    NXTCHR
                        
                        ;************************************************************
                        ;*         PUT NAME IN FCB & SAVE THE IMAGE NEXT
                        ;************************************************************
                        
   11E3                 FILFCB:
   11E3    21 1476              LXI     H,INBUFF+2      ;POINT TO SAVE NAME
   11E6    11 1487              LXI     D,FCBG+1        ;POINT TO FCB NAME LOC
   11E9    3A 1475              LDA     INBUFF+1        ;GET NUMBER OF CHARACTERS






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 34




   11EC    FE00                 CPI     0               ;TEST IF NO NAME
   11EE    CA 11BA              JZ      SAVSYS          ;RETRY
   11F1    FE09                 CPI     9               ;TEST MAX LENGTH
   11F3    3802                 JRC     FILOK
   11F5    3E08                 MVI     A,8
   11F7    01 0000      FILOK:  LXI     B,0             ;ZERO BC
   11FA    4F                   MOV     C,A             ;PUT CHAR. COUNT IN C
   11FB    EDB0                 LDIR                    ;MOVE NAME INTO FCB
                        
                        ;**********************************************************
                        ;*            TEST TO SEE IF FILE EXISTS        
                        ;**********************************************************
                        
   11FD                 DMATCH:
                        
   11FD    0E1A                 MVI     C,DMAF          ;SET UP DMA AREA
   11FF    11 23DD              LXI     D,TBEGIN        ;POINT DMA BUFFER
   1202    CD 0005              CALL    BDOS
   1205    11 1486              LXI     D,FCBG
   1208    0E11                 MVI     C,SEARCH        ;SEARCH FIRST FUNCTION
   120A    CD 0005              CALL    BDOS
   120D    FEFF                 CPI     0FFH
   120F    281F                 JRZ     MAKE1
   1211    11 1313              LXI     D,FMATCH        ;POINT TO FILE MATCH MESS.
   1214    0E09                 MVI     C,PRINTS        ;SEE IF USER WANTS TO KILL
   1216    CD 0005              CALL    BDOS
   1219    0E01                 MVI     C,GCON          ;NOW GET ANSWER
   121B    CD 0005              CALL    BDOS
   121E    FE41                 CPI     'A'             ;SEE IF USER WANTS TO RE-NAME
   1220    2006                 JRNZ    KILF            ;IF NOT GO KILL CURRENT FILE
   1222    CD 11A3              CALL    CLEARF          ;ELSE CLEAR FCB & NAME BUFF
   1225    C3 11BA              JMP     GO0             ;AND GET ANOTHER NAME
                        
   1228    0E13         KILF:   MVI     C,DELETE        ;DELETE FUNCTION
   122A    11 1486              LXI     D,FCBG
   122D    CD 0005              CALL    BDOS
                        
   1230    0E16         MAKE1:  MVI     C,MAKE          ;NOW MAKE FILE IN FCB NAME FIELD
   1232    11 1486              LXI     D,FCBG
   1235    CD 0005              CALL    BDOS            ;DO IT
   1238    FEFF                 CPI     0FFH            ;SEE IF MAKE FAILED
   123A    CA 1287              JZ      FAIL            ;IF SO SHOW FAILURE
                        
                        ;*************************************************************
                        ;*       NOW WRITE THE FILE TO DISK     
                        ;*************************************************************
                        
   123D    ED5B 1471            LDED    IDMALL          ;POINT TO IMAGE
   1241    0E1A                 MVI     C,DMAF          ;SET DMA FUNCTION
   1243    CD 0005              CALL    BDOS
   1246    0E15         WFIL:   MVI     C,WRITEF        ;WRITE RECORD FUNCTION
   1248    11 1486              LXI     D,FCBG          ;POINT FCB
   124B    CD 0005              CALL    BDOS
   124E    FE00                 CPI     0
   1250    2040                 JRNZ    FAIL1           ;IF FAILURE SHOW IT






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 35




   1252    3A 1473              LDA     RECS            ;GET RECORDS
   1255    FE46                 CPI     MRECS           ;TEST FOR END
   1257    CA 1270              JZ      CLOSE1          ;CLOSE OPERATION
   125A    3C                   INR     A               ;ELSE INC. RECORD COUNT
   125B    32 1473              STA     RECS            ;AND SAVE IT
   125E    2A 1471              LHLD    IDMALL          ;GET LAST DMA ADD.
   1261    11 0080              LXI     D,128           ;ADD A RECORD LENGTH
   1264    19                   DAD     D               ;UPDATE POINTER
   1265    22 1471              SHLD    IDMALL          ;SAVE UPDATED DMA
   1268    EB                   XCHG                    ;PUT IN DE
   1269    0E1A                 MVI     C,DMAF          ;DMA FUNCTION
   126B    CD 0005              CALL    BDOS
   126E    18D6                 JMPR    WFIL            ;DO NEXT RECORD
   1270    0E10         CLOSE1: MVI     C,CLOSEF        ;CLOSE FUNCTION
   1272    11 1486              LXI     D,FCBG          ;THIS FCB
   1275    CD 0005              CALL    BDOS            ;DO IT
   1278    FEFF                 CPI     0FFH
   127A    2821                 JRZ     FAIL2           ;SHOW IF FAILED
   127C                 CLOSE2:
   127C    11 139A              LXI     D,MESS3         ;SHOW PROGRAM CREATED O.K.
   127F    0E09                 MVI     C,PRINTS
   1281    CD 0005              CALL    BDOS
   1284    C3 0000              JMP     0
                                
   1287    11 13D0      FAIL:   LXI     D,MESSF
   128A    0E09                 MVI     C,PRINTS
   128C    CD 0005              CALL    BDOS
   128F    C3 0000              JMP     0
   1292    11 1405      FAIL1:  LXI     D,MESSW
   1295    0E09                 MVI     C,PRINTS
   1297    CD 0005              CALL    BDOS
   129A    C3 0000              JMP     0
   129D    11 143B      FAIL2:  LXI     D,MESSC
   12A0    0E09                 MVI     C,PRINTS
   12A2    CD 0005              CALL    BDOS
   12A5    C3 0000              JMP     0
                        
                        
   12A8    1A0A0D       MESS5:  .BYTE   CLEAR,LF,CR
   12AB    202020202020         .ASCII  \              Enter name for this format program, 8 charcter max\
   12EB    0D0A0A               .BYTE   CR,LF,LF
   12EE    202020202020         .ASCII  \                                    $\
                        
                        
   1313    0A0D0D0A     FMATCH: .BYTE   LF,CR,CR,LF
   1317    202020202020         .ASCII  \                   A program with that name already exists,\
   1352    0A0D                 .BYTE   LF,CR
   1354    202020202020         .ASCII  \                 Enter 'A' for another name or <CR> to use this name $\
                        
   139A                 MESS3:
   139A    0D0A0A0A0D           .BYTE   CR,LF,LF,LF,CR
   139F    202020202020         .ASCII  \                                Program created $\
                        
                        
                        ;*****************************************************






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 36




                        ;           FILE I/O ERROR MESSAGES
                        ;*****************************************************
                        
   13D0    0D0A0A       MESSF:  .BYTE   CR,LF,LF
   13D3    202020202020         .ASCII  \                              program make failed$\
                        
   1405    0D0A0A       MESSW:  .BYTE   CR,LF,LF
   1408    202020202020         .ASCII  \                              program write failed$\
                        
   143B    0D0A0A       MESSC:  .BYTE   CR,LF,LF
   143E    202020202020         .ASCII  \                              program close failed$\
                        
                        ;***************************************************
                        ;         PROGRAM STORAGE ARE FOLLOWS
                        ;***************************************************
                        
   1471                 IDMALL:
   1471    00                   .BYTE   0
   1472    01                   .BYTE   1
                        
                        
                        ;RECORDS INITIALIZED TO 0
                        
   1473                 RECS:
   1473    00                   .BYTE   0               ;RECORDS TO WRITE ON SAVE
                        
                        
   1474    102020202020 INBUFF: .BYTE   16,20H,20H,20H,20H,20H,20H,20H
   147C    202020202020         .BYTE   20H,20H,20H,20H,20H,20H,20H,20H,20H,20H
                        
                        ;FCB LOCATION
                        
   1486                 FCBG:
   1486    00                   .BYTE   0
   1487    202020202020         .BYTE   ' ',' ',' ',' ',' ',' ',' ',' '
   148F    434F4D               .ASCII  \COM\
   1492    000000000000         .BYTE   0,0,0,0,0,0,0,0,0,0,0,0
   149E    000000000000         .BYTE   0,0,0,0,0,0,0,0,0,0,0,0
                        
                        ;****************************************************
                        ; TRANSLATION TABLE TO CONVERT A BINARY DRIVE NUMBER
                        ; INTO APPROPRIATE DRIVE SELECT BITS.
                        ;****************************************************
                        
   14AA    0E0D0B07     SELTAB: .BYTE   0EH,0DH,0BH,07H
                        
                        ; ACCEPTABLE CHARACTER TABLE.
                        
   14AE    03415351     TROK:   .BYTE   3,'A','S','Q'   ;ALL OR SYSTEM TRACKS
   14B2    03353851     SIOK:   .BYTE   3,'5','8','Q'   ;5" OR 8"
   14B6    0453445451   DEOK:   .BYTE   4,'S','D','T','Q'       ;SINGLE/DOUBLE DENSITY OR 9 SECTOR SYSTEM
   14BB    053132       LEOK:   .BYTE   5,'1','2'       ;SECTOR SIZE
   14BE    333451               .BYTE   '3','4','Q'
   14C1    0431323351   LEOK5:  .BYTE   4,'1','2','3','Q'
   14C6    03534551     NEOK:   .BYTE   3,'S','E','Q'   ;STANDARD OR EXTENDED ON SPECIAL 5"






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 37




   14CA    03534451     SDOK:   .BYTE   3,'S','D','Q'   ;SINGLE/DOUBLE DENSITY FOR SPECIAL 5"
   14CE    0741424344   DROK:   .BYTE   7,'A','B','C','D'       ;FINAL OPTIONS
   14D3    585153               .BYTE   'X','Q','S'
   14D6    025152       CCOK:   .BYTE   2,'Q','R'       ;'Q' OR 'R' (y/n)
   14D9    03434D51     SYSOK:  .BYTE   3,'C','M','Q'   ;SEE IF FOR MP/M OR CP/M
   14DD    024651       FOROK:  .BYTE   2,'F','Q'
   14E0    025246       QUITOK: .BYTE   2,'R','F'
   14E3    03535651     STDSYS: .BYTE   3,'S','V','Q'
   14E7    0431323351   MEGSOK: .BYTE   4,'1','2','3','Q'   ;1.3, 1.5 OR 1.6 MBYTES
   14EC    03594E51     VEROK:  .BYTE   3,'Y','N','Q'
   14F0    03524E51     ASKOK:  .BYTE   3,'R','N','Q'
                        

















































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 38




                        
                        ;***************************************************
                        ; THE DISK PARAMETER TABLES FOR THE VARIOUS
                        ; DISK SIZES, DENSITIES, AND SECTOR LENGTHS.
                        ;***************************************************
                        
                        ;:::::::::::::::::::::::::::::::::::::::::::::::::::
                        
                        ;***************************************************
                        ;   8" SYSTEM TRACKS OF 9 512 BYTE SECTORS FIRST
                        ;***************************************************
                        
                        
   14F4                 TB:
   14F4    385435       TB8T5:  .BYTE   '8','T','5'
   14F7    24                   .BYTE   LEN8T5
                                
   14F8    F0           D8S001: .BYTE   DCMD8S
   14F9    14FF06000000         .BYTE   20,0FFH,6,0H,0,0H,1,0FCH,16,0FFH
   1503    09                   .BYTE   9
   1504    060000000102         .BYTE   6,0H,0,0H,1,2H,11,0FFH,6,0H,0,0H
   1510    0200                 .WORD   512
   1512    E516FF               .BYTE   0E5H,22,0FFH
   1515    01FF                 .WORD   311+200
   1517    FF                   .BYTE   0FFH
                        
                        
   0024                         LEN8T5  ==      .-TB8T5
                        
                        































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 39




                        
                        ;8" SINGLE DENSITY, 128 BYTES
                        
   1518    385331       TB8S1:  .BYTE   '8','S','1'
   151B    81                   .BYTE   LEN8S1
                        
   151C    F0           D8S002: .BYTE   DCMD8S
   151D    28FF06000000         .BYTE   40,0FFH,6,0H,0,0H,1,0FCH,26,0FFH
   1527    1A                   .BYTE   26
   1528    060000000100         .BYTE   6,0H,0,0H,1,0H,11,0FFH,6,0H,0,0H
   1534    0080                 .WORD   128
   1536    E51BFF               .BYTE   0E5H,27,0FFH
   1539    01BF                 .WORD   247+200
   153B    FF                   .BYTE   0FFH
                        
   153C    20                   .BYTE   ALE8S1
   153D    3A                   .BYTE   DLE8S1
   153E    47                   .BYTE   DDB8S1-TB8S1
                        
   153F    DDFDDDFD     ALT8S1: .BYTE   0DDH,0FDH,0DDH,0FDH
   1543    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   1549    03                   .BYTE   00000011B
   154A    0002                 .WORD   2
   154C    0224001A             .BYTE   2,36,0,26
                        
   1550    001A                 .WORD   26
   1552    040F01               .BYTE   4,15,1
   1555    00F2                 .WORD   242
   1557    007F                 .WORD   127
   1559    C000                 .BYTE   11000000B,0
   155B    0020                 .WORD   32
   155D    0002                 .WORD   2
   0020                 ALE8S1  ==      .-ALT8S1
                        
   155F    DDFDDDFD     DDB8S1: .BYTE   0DDH,0FDH,0DDH,0FDH
   1563    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1569    01                   .BYTE   00000001B
   156A    0002                 .WORD   2
   156C    0224001A             .BYTE   2,36,0,26
                        
   1570    001A                 .WORD   26
   1572    030700               .BYTE   3,7,0
   1575    00F2                 .WORD   242
   1577    003F                 .WORD   63
   1579    C000                 .BYTE   11000000B,0
   157B    0010                 .WORD   16
   157D    0002                 .WORD   2
                        
   157F    01070D131905 TRA8S1: .BYTE   1,7,13,19,25,5,11,17,23,3,9,15,21
   158C    02080E141A06         .BYTE   2,8,14,20,26,6,12,18,24,4,10,16,22
   003A                 DLE8S1  ==      .-DDB8S1
   0081                 LEN8S1  ==      .-TB8S1
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 40




                        




























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 41




                        
                        ;8" SINGLE DENSITY, 256 BYTE SECTORS
                        
   1599    385332       TB8S2:  .BYTE   '8','S','2'
   159C    85                   .BYTE   LEN8S2
                                
   159D    F0           D8S003: .BYTE   DCMD8S
   159E    28FF06000000         .BYTE   40,0FFH,6,0H,0,0H,1,0FCH,26,0FFH
   15A8    0F                   .BYTE   15
   15A9    060000000101         .BYTE   6,0H,0,0H,1,1H,11,0FFH,6,0H,0,0H
   15B5    0100                 .WORD   256
   15B7    E52AFF               .BYTE   0E5H,42,0FFH
   15BA    0172                 .WORD   170+200
   15BC    FF                   .BYTE   0FFH
                        
   15BD    20                   .BYTE   ALE8S2
   15BE    3E                   .BYTE   DLE8S2
   15BF    47                   .BYTE   DDB8S2-TB8S2
                        
   15C0    DDFDDDFD     ALT8S2: .BYTE   0DDH,0FDH,0DDH,0FDH
   15C4    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   15CA    03                   .BYTE   00000011B
   15CB    0002                 .WORD   2
   15CD    0224011E             .BYTE   2,36,1,30
                        
   15D1    001E                 .WORD   30
   15D3    040F00               .BYTE   4,15,0
   15D6    0118                 .WORD   280
   15D8    007F                 .WORD   127
   15DA    C000                 .BYTE   11000000B,0
   15DC    0020                 .WORD   32
   15DE    0002                 .WORD   2
   0020                 ALE8S2  ==      .-ALT8S2
                        
   15E0    DDFDDDFD     DDB8S2: .BYTE   0DDH,0FDH,0DDH,0FDH
   15E4    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   15EA    01                   .BYTE   00000001B
   15EB    0002                 .WORD   2
   15ED    0224011E             .BYTE   2,36,1,30
                        
   15F1    001E                 .WORD   30
   15F3    040F01               .BYTE   4,15,1
   15F6    008B                 .WORD   139
   15F8    003F                 .WORD   63
   15FA    8000                 .BYTE   10000000B,0
   15FC    0010                 .WORD   16
   15FE    0002                 .WORD   2
                        
   1600    01020D0E191A TRA8S2: .BYTE   1,2,13,14,25,26,7,8,19,20
   160A    03040F101B1C         .BYTE   3,4,15,16,27,28,9,10,21,22
   1614    050611121D1E         .BYTE   5,6,17,18,29,30,11,12,23,24
   003E                 DLE8S2  ==      .-DDB8S2
   0085                 LEN8S2  ==      .-TB8S2






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 42




                        
                        



























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 43




                        
                        ;8" SINGLE DENSITY, 512 BYTE SECTORS
                        
   161E    385333       TB8S3:  .BYTE   '8','S','3'
   1621    87                   .BYTE   LEN8S3
                                
   1622    F0           D8S004: .BYTE   DCMD8S
   1623    28FF06000000         .BYTE   40,0FFH,6,0H,0,0H,1,0FCH,26,0FFH
   162D    08                   .BYTE   8
   162E    060000000102         .BYTE   6,0H,0,0H,1,2H,11,0FFH,6,0H,0,0H
   163A    0200                 .WORD   512
   163C    E53AFF               .BYTE   0E5H,58,0FFH
   163F    01FF                 .WORD   311+200
   1641    FF                   .BYTE   0FFH
                        
   1642    20                   .BYTE   ALE8S3
   1643    40                   .BYTE   DLE8S3
   1644    47                   .BYTE   DDB8S3-TB8S3
                        
   1645    DDFDDDFD     ALT8S3: .BYTE   0DDH,0FDH,0DDH,0FDH
   1649    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   164F    03                   .BYTE   00000011B
   1650    0002                 .WORD   2
   1652    02240220             .BYTE   2,36,2,32
                        
   1656    0020                 .WORD   32
   1658    040F00               .BYTE   4,15,0
   165B    012B                 .WORD   299
   165D    007F                 .WORD   127
   165F    C000                 .BYTE   11000000B,0
   1661    0020                 .WORD   32
   1663    0002                 .WORD   2
   0020                 ALE8S3  ==      .-ALT8S3
                        
   1665    DDFDDDFD     DDB8S3: .BYTE   0DDH,0FDH,0DDH,0FDH
   1669    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   166F    01                   .BYTE   00000001B
   1670    0002                 .WORD   2
   1672    02240220             .BYTE   2,36,2,32
                        
   1676    0020                 .WORD   32
   1678    040F01               .BYTE   4,15,1
   167B    0095                 .WORD   149
   167D    003F                 .WORD   63
   167F    8000                 .BYTE   10000000B,0
   1681    0010                 .WORD   16
   1683    0002                 .WORD   2
                        
   1685    010203040D0E TRA8S3: .BYTE   1,2,3,4,13,14,15,16,25,26,27,28
   1691    050607081112         .BYTE   5,6,7,8,17,18,19,20,29,30,31,32
   169D    090A0B0C1516         .BYTE   9,10,11,12,21,22,23,24
   0040                 DLE8S3  ==      .-DDB8S3
   0087                 LEN8S3  ==      .-TB8S3






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 44




                        
                        



























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 45




                        
                        ;8" SINGLE DENSITY, 1024 BYTE SECTORS
                        
   16A5                 TB8S4:
   16A5    385334               .BYTE   '8','S','4'
   16A8    87                   .BYTE   LEN8S4
                        
   16A9    F0           D8S005: .BYTE   DCMD8S
   16AA    28FF06000000         .BYTE   40,0FFH,6,0H,0,0H,1,0FCH,16,0FFH
   16B4    04                   .BYTE   4
   16B5    060000000103         .BYTE   6,0H,0,0H,1,3H,16,0FFH,6,0H,0,0H
   16C1    0400                 .WORD   1024
   16C3    E528FF               .BYTE   0E5H,40,0FFH
   16C6    012C                 .WORD   150+150
   16C8    FF                   .BYTE   0FFH
                        
   16C9    20                   .BYTE   ALE8S4
   16CA    40                   .BYTE   DLE8S4
   16CB    47                   .BYTE   DDB8S4-TB8S4
                        
   16CC    DDFDDDFD     ALT8S4: .BYTE   0DDH,0FDH,0DDH,0FDH
   16D0    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   16D6    03                   .BYTE   00000011B
   16D7    0002                 .WORD   2
   16D9    02240320             .BYTE   2,36,3,32
                        
   16DD    0020                 .WORD   32
   16DF    040F00               .BYTE   4,15,0
   16E2    0129                 .WORD   297
   16E4    00BF                 .WORD   191     
   16E6    E000                 .BYTE   11100000B,0
   16E8    0030                 .WORD   48      
   16EA    0002                 .WORD   2
   0020                 ALE8S4  ==      .-ALT8S4
                        
   16EC    DDFDDDFD     DDB8S4: .BYTE   0DDH,0FDH,0DDH,0FDH
   16F0    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   16F6    01                   .BYTE   00000001B
   16F7    0002                 .WORD   2
   16F9    02240320             .BYTE   2,36,3,32
                        
   16FD    0020                 .WORD   32
   16FF    040F01               .BYTE   4,15,1
   1702    0094                 .WORD   148
   1704    003F                 .WORD   63
   1706    8000                 .BYTE   10000000B,0
   1708    0010                 .WORD   16
   170A    0002                 .WORD   2
                        
   170C    010203040506 TRA8S4: .BYTE   1,2,3,4,5,6,7,8
   1714    191A1B1C1D1E         .BYTE   25,26,27,28,29,30,31,32
   171C    111213141516         .BYTE   17,18,19,20,21,22,23,24
   1724    090A0B0C0D0E         .BYTE   09,10,11,12,13,14,15,16






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 46




                        
   0040                 DLE8S4  ==      .-DDB8S4
   0087                 LEN8S4  ==      .-TB8S4
                        
                        
























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 47




                        
                        ;8" DOUBLE DENSITY, 128 BYTE SECTORS
                        
   172C    384431       TB8D1:  .BYTE   '8','D','1'
   172F    91                   .BYTE   LEN8D1
                        
   1730    B0           D8D001: .BYTE   DCMD8D
   1731    504E0C0003F6         .BYTE   80,04EH,12,0H,3,0F6H,1,0FCH,50,04EH
   173B    2A                   .BYTE   42
   173C    0C0003F50100         .BYTE   12,0H,3,0F5H,1,0H,22,04EH,12,0H,3,0F5H
   1748    0080                 .WORD   128
   174A    E52E4E               .BYTE   0E5H,46,04EH
   174D    02F7                 .WORD   359+400
   174F    4E                   .BYTE   04EH
                        
   1750    20                   .BYTE   ALE8D1
   1751    4A                   .BYTE   DLE8D1
   1752    47                   .BYTE   DDB8D1-TB8D1
                        
   1753    DDFDDDFD     ALT8D1: .BYTE   0DDH,0FDH,0DDH,0FDH
   1757    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   175D    0B                   .BYTE   00001011B
   175E    0002                 .WORD   2
   1760    0224002A             .BYTE   2,36,0,42
                        
   1764    002A                 .WORD   42
   1766    040F00               .BYTE   4,15,0
   1769    0188                 .WORD   392
   176B    007F                 .WORD   127     
   176D    E000                 .BYTE   11100000B,0
   176F    0020                 .WORD   32      
   1771    0002                 .WORD   2
   0020                 ALE8D1  ==      .-ALT8D1
                        
   1773    DDFDDDFD     DDB8D1: .BYTE   0DDH,0FDH,0DDH,0FDH
   1777    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   177D    09                   .BYTE   00001001B
   177E    0002                 .WORD   2
   1780    0224002A             .BYTE   2,36,0,42
                        
   1784    002A                 .WORD   42
   1786    040F01               .BYTE   4,15,1
   1789    00C3                 .WORD   195
   178B    007F                 .WORD   127
   178D    C000                 .BYTE   11000000B,0
   178F    0020                 .WORD   32
   1791    0002                 .WORD   2
                        
   1793    010A131C2504 TRA8D1: .BYTE   1,10,19,28,37,4,13,22,31,40,7
   179E    101922020B14         .BYTE   16,25,34,2,11,20,29,38,5,14,23
   17A9    202908111A23         .BYTE   32,41,8,17,26,35,3,12,21,30,39
   17B4    060F18212A09         .BYTE   6,15,24,33,42,9,18,27,36
   004A                 DLE8D1  ==      .-DDB8D1






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 48




   0091                 LEN8D1  ==      .-TB8D1
                        
                        


























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 49




                        
                        ;8" DOUBLE DENSITY, 256 BYTE SECTORS
                        
   17BD    384432       TB8D2:  .BYTE   '8','D','2'
   17C0    9B                   .BYTE   LEN8D2
                        
   17C1    B0           D8D002: .BYTE   DCMD8D
   17C2    504E0C0003F6         .BYTE   80,04EH,12,0H,3,0F6H,1,0FCH,50,04EH
   17CC    1A                   .BYTE   26
   17CD    0C0003F50101         .BYTE   12,0H,3,0F5H,1,1H,22,04EH,12,0H,3,0F5H
   17D9    0100                 .WORD   256
   17DB    E5364E               .BYTE   0E5H,54,04EH
   17DE    03E6                 .WORD   598+400
   17E0    4E                   .BYTE   04EH
                        
   17E1    20                   .BYTE   ALE8D2
   17E2    54                   .BYTE   DLE8D2
   17E3    47                   .BYTE   DDB8D2-TB8D2
                        
   17E4    DDFDDDFD     ALT8D2: .BYTE   0DDH,0FDH,0DDH,0FDH
   17E8    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   17EE    0B                   .BYTE   00001011B
   17EF    0002                 .WORD   2
   17F1    02240134             .BYTE   2,36,1,52
                        
   17F5    0034                 .WORD   52
   17F7    040F00               .BYTE   4,15,0
   17FA    01E6                 .WORD   486
   17FC    00BF                 .WORD   191     
   17FE    E000                 .BYTE   11100000B,0
   1800    0030                 .WORD   48      
   1802    0002                 .WORD   2
   0020                 ALE8D2  ==      .-ALT8D2
                        
   1804    DDFDDDFD     DDB8D2: .BYTE   0DDH,0FDH,0DDH,0FDH
   1808    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   180E    09                   .BYTE   00001001B
   180F    0002                 .WORD   2
   1811    02240134             .BYTE   2,36,1,52
                        
   1815    0034                 .WORD   52
   1817    040F01               .BYTE   4,15,1
   181A    00F2                 .WORD   242
   181C    007F                 .WORD   127
   181E    C000                 .BYTE   11000000B,0
   1820    0020                 .WORD   32
   1822    0002                 .WORD   2
                        
   1824    010213142526 TRA8D2: .BYTE   1,2,19,20,37,38,3,4,21,22,39,40
   1830    05061718292A         .BYTE   5,6,23,24,41,42,7,8,25,26,43,44
   183C    090A1B1C2D2E         .BYTE   9,10,27,28,45,46,11,12,29,30,47,48                
   1848    0D0E1F203132         .BYTE   13,14,31,32,49,50,15,16,33,34
   1852    333411122324         .BYTE   51,52,17,18,35,36






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 50




                        
   0054                 DLE8D2  ==      .-DDB8D2
   009B                 LEN8D2  ==      .-TB8D2
                        
                        
























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 51




                        
                        ;8" DOUBLE DENSITY, 512 BYTE SECTORS
                        
   1858    384433       TB8D3:  .BYTE   '8','D','3'
   185B    A3                   .BYTE   LEN8D3
                        
   185C    B0           D8D003: .BYTE   DCMD8D
   185D    504E0C0003F6         .BYTE   80,04EH,12,0H,3,0F6H,1,0FCH,50,04EH
   1867    0F                   .BYTE   15
   1868    0C0003F50102         .BYTE   12,0H,3,0F5H,1,2H,22,04EH,12,0H,3,0F5H
   1874    0200                 .WORD   512
   1876    E5544E               .BYTE   0E5H,84,04EH
   1879    0320                 .WORD   400+400
   187B    4E                   .BYTE   04EH
                        
   187C    20                   .BYTE   ALE8D3
   187D    5C                   .BYTE   DLE8D3
   187E    47                   .BYTE   DDB8D3-TB8D3
                        
   187F    DDFDDDFD     ALT8D3: .BYTE   0DDH,0FDH,0DDH,0FDH
   1883    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1889    0B                   .BYTE   00001011B
   188A    0002                 .WORD   2
   188C    0224023C             .BYTE   2,36,2,60
                        
   1890    003C                 .WORD   60
   1892    040F00               .BYTE   4,15,0
   1895    0231                 .WORD   561
   1897    00BF                 .WORD   191             ;MAXIMUM IS 255
   1899    E000                 .BYTE   11100000B,0
   189B    0030                 .WORD   48              ;MAXIMUM IS 64
   189D    0002                 .WORD   2
   0020                 ALE8D3  ==      .-ALT8D3
                        
   189F    DDFDDDFD     DDB8D3: .BYTE   0DDH,0FDH,0DDH,0FDH
   18A3    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   18A9    09                   .BYTE   00001001B
   18AA    0002                 .WORD   2
   18AC    0224023C             .BYTE   2,36,2,60
                        
   18B0    003C                 .WORD   60
   18B2    040F00               .BYTE   4,15,0
   18B5    0118                 .WORD   280
   18B7    00BF                 .WORD   191
   18B9    E000                 .BYTE   11100000B,0
   18BB    0030                 .WORD   48
   18BD    0002                 .WORD   2
                        
   18BF    010203041112 TRA8D3: .BYTE   1,2,3,4,17,18,19,20,33,34,35,36
   18CB    313233340506         .BYTE   49,50,51,52,5,6,7,8,21,22,23,24
   18D7    252627283536         .BYTE   37,38,39,40,53,54,55,56,9,10,11,12
   18E3    191A1B1C292A         .BYTE   25,26,27,28,41,42,43,44,57,58,59,60
   18EF    0D0E0F101D1E         .BYTE   13,14,15,16,29,30,31,32,45,46,47,48






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 52




   005C                 DLE8D3  ==      .-DDB8D3
   00A3                 LEN8D3  ==      .-TB8D3
                        
                        

























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 53




                        
                        ;8" DOUBLE DENSITY, 1024 BYTE SECTORS
                        ;11 SECTORS PER TRACK
   18FB                 TB8D4:
   18FB    384434               .BYTE   '8','D','4'
   18FE    BF                   .BYTE   LEN8D4
   18FF    B0           D8D004: .BYTE   DCMD8D
   1900    1E4E0C0003F6         .BYTE   30,04EH,12,0H,3,0F6H,1,0FCH,20,04EH
                        ;       .BYTE   80,04EH,12,0H,3,0F6H,1,0FCH,50,04EH <- JUST FOR INTEREST
   190A    0B                   .BYTE   11
   190B    0C0003F50103         .BYTE   12,0H,3,0F5H,1,3H,22,04EH,12,0H,3,0F5H
   1917    0400                 .WORD   1024
   1919    E51A4E               .BYTE   0E5H,26,04EH
                        ;       .BYTE   0E5H,54,04EH <- JUST FOR INTEREST
   191C    0320                 .WORD   400+400
   191E    4E                   .BYTE   04EH
   191F    20                   .BYTE   ALE8D4
   1920    78                   .BYTE   DLE8D4
   1921    47                   .BYTE   DDB8D4-TB8D4
   1922    DDFDDDFD     ALT8D4: .BYTE   0DDH,0FDH,0DDH,0FDH
   1926    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   192C    0B                   .BYTE   00001011B
   192D    0002                 .WORD   2
   192F    02240358             .BYTE   2,36,3,88
   1933    0058                 .WORD   88
   1935    040F00               .BYTE   4,15,0
   1938    0340                 .WORD   832
   193A    00FF                 .WORD   255             ;MAXIMUM IS 255 (256 ACTUAL)
   193C    F000                 .BYTE   11110000B,0
   193E    0040                 .WORD   64              ;MAXIMUM IS 64
   1940    0002                 .WORD   2
   0020                 ALE8D4  ==      .-ALT8D4
   1942    DDFDDDFD     DDB8D4: .BYTE   0DDH,0FDH,0DDH,0FDH
   1946    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   194C    09                   .BYTE   00001001B
   194D    0002                 .WORD   2
   194F    02240358             .BYTE   2,36,3,88
   1953    0058                 .WORD   88
   1955    040F00               .BYTE   4,15,0
   1958    01A0                 .WORD   416
   195A    00BF                 .WORD   191
   195C    E000                 .BYTE   11100000B,0
   195E    0030                 .WORD   48
   1960    0002                 .WORD   2
   1962                 TRA8D4:
   1962    010203040506         .BYTE   1,2,3,4,5,6,7,8
   196A    111213141516         .BYTE   17,18,19,20,21,22,23,24
   1972    212223242526         .BYTE   33,34,35,36,37,38,39,40                
   197A    313233343536         .BYTE   49,50,51,52,53,54,55,56
   1982    414243444546         .BYTE   65,66,67,68,69,70,71,72
   198A    515253545556         .BYTE   81,82,83,84,85,86,87,88
   1992    090A0B0C0D0E         .BYTE   09,10,11,12,13,14,15,16
   199A    191A1B1C1D1E         .BYTE   25,26,27,28,29,30,31,32
   19A2    292A2B2C2D2E         .BYTE   41,42,43,44,45,46,47,48
   19AA    393A3B3C3D3E         .BYTE   57,58,59,60,61,62,63,64






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 54




   19B2    494A4B4C4D4E         .BYTE   73,74,75,76,77,78,79,80
                                
   0078                 DLE8D4  ==      .-DDB8D4
   00BF                 LEN8D4  ==      .-TB8D4
                        
























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 55




                        
                        ;5" SINGLE DENSITY, 128 BYTE SECTORS
                        
   19BA    355331       TB5S1:  .BYTE   '5','S','1'
   19BD    79                   .BYTE   LEN5S1
                        
   19BE    D0           D5S001: .BYTE   DCMD5S
   19BF    000000000000         .BYTE   0,0H,0,0H,0,0H,0,0H,16,0FFH
   19C9    12                   .BYTE   18
   19CA    040000000100         .BYTE   4,0H,0,0H,1,0H,11,0FFH,6,0H,0,0H
   19D6    0080                 .WORD   128
   19D8    E50AFF               .BYTE   0E5H,10,0FFH
   19DB    010B                 .WORD   67+200
   19DD    FF                   .BYTE   0FFH
                        
   19DE    20                   .BYTE   ALE5S1
   19DF    32                   .BYTE   DLE5S1
   19E0    47                   .BYTE   DDB5S1-TB5S1
                        
   19E1    DDFDDDFD     ALT5S1: .BYTE   0DDH,0FDH,0DDH,0FDH
   19E5    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   19EB    17                   .BYTE   00010111B
   19EC    0003                 .WORD   3
   19EE    02240012             .BYTE   2,36,0,18
                        
   19F2    0012                 .WORD   18
   19F4    030700               .BYTE   3,7,0
   19F7    008F                 .WORD   143
   19F9    003F                 .WORD   63
   19FB    C000                 .BYTE   11000000B,0
   19FD    0010                 .WORD   16
   19FF    0003                 .WORD   3
   0020                 ALE5S1  ==      .-ALT5S1
                        
   1A01    DDFDDDFD     DDB5S1: .BYTE   0DDH,0FDH,0DDH,0FDH
   1A05    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1A0B    15                   .BYTE   00010101B
   1A0C    0003                 .WORD   3
   1A0E    02240012             .BYTE   2,36,0,18
                        
   1A12    0012                 .WORD   18
   1A14    030700               .BYTE   3,7,0
   1A17    0047                 .WORD   71
   1A19    003F                 .WORD   63
   1A1B    C000                 .BYTE   11000000B,0
   1A1D    0010                 .WORD   16
   1A1F    0003                 .WORD   3
                        
   1A21    0105090D1103 TRA5S1: .BYTE   1,5,9,13,17,3,7,11,15
   1A2A    02060A0E1204         .BYTE   2,6,10,14,18,4,8,12,16
   0032                 DLE5S1  ==      .-DDB5S1
   0079                 LEN5S1  ==      .-TB5S1
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 56




                        




























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 57




                        
                        ;5" SINGLE DENSITY, 512 BYTE SECTORS
                        
   1A33    355333       TB5S3:  .BYTE   '5','S','3'
   1A36    7B                   .BYTE   LEN5S3
                                
   1A37    D0           D5S002: .BYTE   DCMD5S
   1A38    000000000000         .BYTE   0,0H,0,0H,0,0H,0,0H,24,0FFH
   1A42    05                   .BYTE   5
   1A43    060000000102         .BYTE   6,0H,0,0H,1,2H,11,0FFH,6,0H,0,0H
   1A4F    0200                 .WORD   512
   1A51    E52EFF               .BYTE   0E5H,46,0FFH
   1A54    015A                 .WORD   146+200
   1A56    FF                   .BYTE   0FFH
                        
   1A57    20                   .BYTE   ALE5S3
   1A58    34                   .BYTE   DLE5S3
   1A59    47                   .BYTE   DDB5S3-TB5S3
                        
   1A5A    DDFDDDFD     ALT5S3: .BYTE   0DDH,0FDH,0DDH,0FDH
   1A5E    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1A64    17                   .BYTE   00010111B
   1A65    0003                 .WORD   3
   1A67    02240214             .BYTE   2,36,2,20
                        
   1A6B    0014                 .WORD   20
   1A6D    030700               .BYTE   3,7,0
   1A70    009F                 .WORD   159
   1A72    003F                 .WORD   63
   1A74    C000                 .BYTE   11000000B,0
   1A76    0010                 .WORD   16
   1A78    0003                 .WORD   3
   0020                 ALE5S3  ==      .-ALT5S3
                        
   1A7A    DDFDDDFD     DDB5S3: .BYTE   0DDH,0FDH,0DDH,0FDH
   1A7E    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1A84    15                   .BYTE   00010101B
   1A85    0003                 .WORD   3
   1A87    02240214             .BYTE   2,36,2,20
                        
   1A8B    0014                 .WORD   20
   1A8D    030700               .BYTE   3,7,0
   1A90    004F                 .WORD   79
   1A92    003F                 .WORD   63
   1A94    C000                 .BYTE   11000000B,0
   1A96    0010                 .WORD   16
   1A98    0003                 .WORD   3
                        
   1A9A    01020304090A TRA5S3: .BYTE   1,2,3,4,9,10,11,12,17,18,19,20
   1AA6    050607080D0E         .BYTE   5,6,7,8,13,14,15,16
   0034                 DLE5S3  ==      .-DDB5S3
   007B                 LEN5S3  ==      .-TB5S3
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 58




                        




























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 59




                        
                        ;5" SINGLE DENSITY, 1024 BYTE SECTORS
                        
   1AAE                 TB5S4:
   1AAE    355334               .BYTE   '5','S','4'
   1AB1    7F                   .BYTE   LEN5S4
                        
   1AB2    D0           D5S003: .BYTE   DCMD5S
   1AB3    000000000000         .BYTE   0,0H,0,0H,0,0H,0,0H,24,0FFH
   1ABD    03                   .BYTE   3
   1ABE    060000000103         .BYTE   6,0H,0,0H,1,3H,11,0FFH,6,0H,0,0H
   1ACA    0400                 .WORD   1024
   1ACC    E52E4E               .BYTE   0E5H,46,04EH
   1ACF    012C                 .WORD   150+150
   1AD1    4E                   .BYTE   04EH
                        
   1AD2    20                   .BYTE   ALE5S4
   1AD3    38                   .BYTE   DLE5S4
   1AD4    47                   .BYTE   DDB5S4-TB5S4
                        
   1AD5    DDFDDDFD     ALT5S4: .BYTE   0DDH,0FDH,0DDH,0FDH
   1AD9    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1ADF    17                   .BYTE   00010111B
   1AE0    0003                 .WORD   3
   1AE2    02240318             .BYTE   2,36,3,24
                        
   1AE6    0018                 .WORD   24
   1AE8    030700               .BYTE   3,7,0
   1AEB    00B9                 .WORD   185
   1AED    003F                 .WORD   63      
   1AEF    C000                 .BYTE   11000000B,0
   1AF1    0010                 .WORD   16      
   1AF3    0003                 .WORD   3
   0020                 ALE5S4  ==      .-ALT5S4
                        
   1AF5    DDFDDDFD     DDB5S4: .BYTE   0DDH,0FDH,0DDH,0FDH
   1AF9    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1AFF    15                   .BYTE   00010101B
   1B00    0003                 .WORD   3
   1B02    02240318             .BYTE   2,36,3,24
                        
   1B06    0018                 .WORD   24
   1B08    030700               .BYTE   3,7,0
   1B0B    005C                 .WORD   92
   1B0D    003F                 .WORD   63
   1B0F    C000                 .BYTE   11000000B,0
   1B11    0010                 .WORD   16
   1B13    0003                 .WORD   3
                        
   1B15    010203040506 TRA5S4: .BYTE   1,2,3,4,5,6,7,8
   1B1D    111213141516         .BYTE   17,18,19,20,21,22,23,24
   1B25    090A0B0C0D0E         .BYTE   09,10,11,12,13,14,15,16
                        






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 60




                        
   0038                 DLE5S4  ==      .-DDB5S4
   007F                 LEN5S4  ==      .-TB5S4
                        
                        
























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 61




                        
                        ;5" DOUBLE DENSITY, 128 BYTE SECTORS
                        
   1B2D    354431       TB5D1:  .BYTE   '5','D','1'
   1B30    82                   .BYTE   LEN5D1
                        
   1B31    90           D5D001: .BYTE   DCMD5D
   1B32    000000000000         .BYTE   0,0H,0,0H,0,0H,0,0H,32,04EH
   1B3C    1B                   .BYTE   27
   1B3D    0C0003F50100         .BYTE   12,0H,3,0F5H,1,0H,22,04EH,12,0H,3,0F5H
   1B49    0080                 .WORD   128
   1B4B    E51E4E               .BYTE   0E5H,30,04EH
   1B4E    02A6                 .WORD   278+400
   1B50    4E                   .BYTE   04EH
                        
   1B51    20                   .BYTE   ALE5D1
   1B52    3B                   .BYTE   DLE5D1
   1B53    47                   .BYTE   DDB5D1-TB5D1
                        
   1B54    DDFDDDFD     ALT5D1: .BYTE   0DDH,0FDH,0DDH,0FDH
   1B58    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1B5E    1F                   .BYTE   00011111B
   1B5F    0003                 .WORD   3
   1B61    0224001B             .BYTE   2,36,0,27
                        
   1B65    001B                 .WORD   27
   1B67    030700               .BYTE   3,7,0
   1B6A    00D7                 .WORD   215
   1B6C    003F                 .WORD   63
   1B6E    C000                 .BYTE   11000000B,0
   1B70    0010                 .WORD   16
   1B72    0003                 .WORD   3
   0020                 ALE5D1  ==      .-ALT5D1
                        
   1B74    DDFDDDFD     DDB5D1: .BYTE   0DDH,0FDH,0DDH,0FDH
   1B78    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1B7E    1D                   .BYTE   00011101B
   1B7F    0003                 .WORD   3
   1B81    0224001B             .BYTE   2,36,0,27
                        
   1B85    001B                 .WORD   27
   1B87    030700               .BYTE   3,7,0
   1B8A    006B                 .WORD   107
   1B8C    003F                 .WORD   63
   1B8E    C000                 .BYTE   11000000B,0
   1B90    0010                 .WORD   16
   1B92    0003                 .WORD   3
                        
   1B94    01060B10151A TRA5D1: .BYTE   1,6,11,16,21,26,4,9,14
   1B9D    131802070C11         .BYTE   19,24,2,7,12,17,22,27,5
   1BA6    0A0F14190308         .BYTE   10,15,20,25,3,8,13,18,23
   003B                 DLE5D1  ==      .-DDB5D1
   0082                 LEN5D1  ==      .-TB5D1






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 62




                        
                        



























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 63




                        
                        ;5" DOUBLE DENSITY, 256 BYTE SECTORS
                        
   1BAF    354432       TB5D2:  .BYTE   '5','D','2'
   1BB2    87                   .BYTE   LEN5D2
                        
   1BB3    90           D5D002: .BYTE   DCMD5D
   1BB4    000000000000         .BYTE   0,0H,0,0H,0,0H,0,0H,32,04EH
   1BBE    10                   .BYTE   16
   1BBF    0C0003F50101         .BYTE   12,0H,3,0F5H,1,1H,22,04EH,12,0H,3,0F5H
   1BCB    0100                 .WORD   256
   1BCD    E5364E               .BYTE   0E5H,54,04EH
   1BD0    029A                 .WORD   266+400
   1BD2    4E                   .BYTE   04EH
                        
   1BD3    20                   .BYTE   ALE5D2
   1BD4    40                   .BYTE   DLE5D2
   1BD5    47                   .BYTE   DDB5D2-TB5D2
                        
   1BD6    DDFDDDFD     ALT5D2: .BYTE   0DDH,0FDH,0DDH,0FDH
   1BDA    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1BE0    1F                   .BYTE   00011111B
   1BE1    0003                 .WORD   3
   1BE3    02240120             .BYTE   2,36,1,32
                        
   1BE7    0020                 .WORD   32
   1BE9    030700               .BYTE   3,7,0
   1BEC    00FF                 .WORD   255
   1BEE    003F                 .WORD   63
   1BF0    C000                 .BYTE   11000000B,0
   1BF2    0010                 .WORD   16
   1BF4    0003                 .WORD   3
   0020                 ALE5D2  ==      .-ALT5D2
                        
   1BF6    DDFDDDFD     DDB5D2: .BYTE   0DDH,0FDH,0DDH,0FDH
   1BFA    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1C00    1D                   .BYTE   00011101B
   1C01    0003                 .WORD   3
   1C03    02240120             .BYTE   2,36,1,32
                        
   1C07    0020                 .WORD   32
   1C09    030700               .BYTE   3,7,0
   1C0C    007F                 .WORD   127
   1C0E    003F                 .WORD   63
   1C10    C000                 .BYTE   11000000B,0
   1C12    0010                 .WORD   16
   1C14    0003                 .WORD   3
                        
   1C16    01020D0E191A TRA5D2: .BYTE   1,2,13,14,25,26,5,6,17,18,29,30
   1C22    090A15160304         .BYTE   9,10,21,22,3,4,15,16,27,28,7,8
   1C2E    13141F200B0C         .BYTE   19,20,31,32,11,12,23,24
   0040                 DLE5D2  ==      .-DDB5D2
   0087                 LEN5D2  ==      .-TB5D2






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 64




                        
                        



























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 65




                        
                        ;5" DOUBLE DENSITY, 512 BYTE SECTORS
                        
   1C36    354433       TB5D3:  .BYTE   '5','D','3'
   1C39    8B                   .BYTE   LEN5D3
                        
   1C3A    90           D5D003: .BYTE   DCMD5D
   1C3B    000000000000         .BYTE   0,0H,0,0H,0,0H,0,0H,32,04EH
   1C45    09                   .BYTE   9
   1C46    0C0003F50102         .BYTE   12,0H,3,0F5H,1,2H,22,04EH,12,0H,3,0F5H
   1C52    0200                 .WORD   512
   1C54    E5544E               .BYTE   0E5H,84,04EH
   1C57    02B8                 .WORD   296+400
   1C59    4E                   .BYTE   04EH
                        
   1C5A    20                   .BYTE   ALE5D3
   1C5B    44                   .BYTE   DLE5D3
   1C5C    47                   .BYTE   DDB5D3-TB5D3
                        
   1C5D    DDFDDDFD     ALT5D3: .BYTE   0DDH,0FDH,0DDH,0FDH
   1C61    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   1C67    1F                   .BYTE   00011111B
   1C68    0003                 .WORD   3
   1C6A    02240224             .BYTE   2,36,2,36
                        
   1C6E    0024                 .WORD   36
   1C70    040F01               .BYTE   4,15,1
   1C73    008F                 .WORD   143
   1C75    003F                 .WORD   63
   1C77    8000                 .BYTE   10000000B,0
   1C79    0010                 .WORD   16
   1C7B    0003                 .WORD   3
   0020                 ALE5D3  ==      .-ALT5D3
                        
   1C7D    DDFDDDFD     DDB5D3: .BYTE   0DDH,0FDH,0DDH,0FDH
   1C81    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1C87    1D                   .BYTE   00011101B
   1C88    0003                 .WORD   3
   1C8A    02240224             .BYTE   2,36,2,36
                        
   1C8E    0024                 .WORD   36
   1C90    030700               .BYTE   3,7,0
   1C93    008F                 .WORD   143
   1C95    003F                 .WORD   63
   1C97    C000                 .BYTE   11000000B,0
   1C99    0010                 .WORD   16
   1C9B    0003                 .WORD   3
                        
   1C9D    010203040D0E TRA5D3: .BYTE   1,2,3,4,13,14,15,16,25,26,27,28
   1CA9    050607081112         .BYTE   5,6,7,8,17,18,19,20,29,30,31,32
   1CB5    090A0B0C1516         .BYTE   9,10,11,12,21,22,23,24,33,34,35,36
   0044                 DLE5D3  ==      .-DDB5D3
   008B                 LEN5D3  ==      .-TB5D3






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 66




                        
                        



























































TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 67




                        
                        ;5" DOUBLE DENSITY, 1024 BYTE SECTORS
                        
   1CC1                 TB5D4:
   1CC1    354434               .BYTE   '5','D','4'
   1CC4    8D                   .BYTE   LEN5D4
                        
   1CC5    90           D5D004: .BYTE   DCMD5D
   1CC6    000000000000         .BYTE   0,0H,0,0H,0,0H,32,04EH
   1CCE    05                   .BYTE   5
   1CCF    0C0003F50103         .BYTE   12,0H,3,0F5H,1,3H,22,04EH,12,0H,3,0F5H
   1CDB    0400                 .WORD   1024
   1CDD    E5364E               .BYTE   0E5H,54,04EH
   1CE0    01F4                 .WORD   250+250
   1CE2    4E                   .BYTE   04EH
                        
   1CE3    20                   .BYTE   ALE5D4
   1CE4    48                   .BYTE   DLE5D4
   1CE5    45                   .BYTE   DDB5D4-TB5D4
                        
   1CE6    DDFDDDFD     ALT5D4: .BYTE   0DDH,0FDH,0DDH,0FDH
   1CEA    010000000000         .BYTE   1H,0H,0H,0H,0H,0H
                        
   1CF0    1F                   .BYTE   00011111B
   1CF1    0003                 .WORD   3
   1CF3    02240328             .BYTE   2,36,3,40
                        
   1CF7    0028                 .WORD   40
   1CF9    040F01               .BYTE   4,15,1
   1CFC    0098                 .WORD   152
   1CFE    003F                 .WORD   63      
   1D00    8000                 .BYTE   10000000B,0
   1D02    0010                 .WORD   16      
   1D04    0003                 .WORD   3
   0020                 ALE5D4  ==      .-ALT5D4
                        
   1D06    DDFDDDFD     DDB5D4: .BYTE   0DDH,0FDH,0DDH,0FDH
   1D0A    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
                        
   1D10    1D                   .BYTE   00011101B
   1D11    0003                 .WORD   3
   1D13    02240328             .BYTE   2,36,3,40
                        
   1D17    0028                 .WORD   40
   1D19    030700               .BYTE   3,7,0
   1D1C    0098                 .WORD   152
   1D1E    003F                 .WORD   63
   1D20    C000                 .BYTE   11000000B,0
   1D22    0010                 .WORD   16
   1D24    0003                 .WORD   3
                        
   1D26    010203040506 TRA5D4: .BYTE   1,2,3,4,5,6,7,8
   1D2E    111213141516         .BYTE   17,18,19,20,21,22,23,24
   1D36    212223242526         .BYTE   33,34,35,36,37,38,39,40                
   1D3E    090A0B0C0D0E         .BYTE   09,10,11,12,13,14,15,16






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 68




   1D46    191A1B1C1D1E         .BYTE   25,26,27,28,29,30,31,32
                        
   0048                 DLE5D4  ==      .-DDB5D4
   008D                 LEN5D4  ==      .-TB5D4
                        
                        
   1D4E    00                   .BYTE   0       ;END OF TABLES
                        
                        
                        ;8" DOUBLE DENSITY, 1024 BYTE SECTORS
                        ;9 SECTORS PER TRACK = 1.3 MBYTES
   1D4F                 TB09S:
   1D4F    384434               .BYTE   '8','D','4'
   1D52    BF                   .BYTE   LEN8D4          ;<- A LIE, BUT NEEDED FOR INDEX LEN09S
   1D53    B0           D8D005: .BYTE   DCMD8D
   1D54    504E0C0003F6         .BYTE   80,04EH,12,0H,3,0F6H,1,0FCH,50,04EH
   1D5E    09                   .BYTE   9
   1D5F    0C0003F50103         .BYTE   12,0H,3,0F5H,1,3H,22,04EH,12,0H,3,0F5H
   1D6B    0400                 .WORD   1024
   1D6D    E5364E               .BYTE   0E5H,54,04EH
   1D70    0320                 .WORD   400+400
   1D72    4E                   .BYTE   04EH
   1D73    20                   .BYTE   ALE09S
   1D74    68                   .BYTE   DLE09S
   1D75    47                   .BYTE   DDB09S-TB09S
   1D76    DDFDDDFD     ALT09S: .BYTE   0DDH,0FDH,0DDH,0FDH
   1D7A    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   1D80    0B                   .BYTE   00001011B
   1D81    0002                 .WORD   2
   1D83    02240348             .BYTE   2,36,3,72
   1D87    0048                 .WORD   72
   1D89    040F00               .BYTE   4,15,0
   1D8C    029E                 .WORD   670
   1D8E    00FF                 .WORD   255             ;MAXIMUM IS 255 (256 ACTUAL)
   1D90    F000                 .BYTE   11110000B,0
   1D92    0040                 .WORD   64              ;MAXIMUM IS 64
   1D94    0002                 .WORD   2
   0020                 ALE09S  ==      .-ALT09S
   1D96    DDFDDDFD     DDB09S: .BYTE   0DDH,0FDH,0DDH,0FDH
   1D9A    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   1DA0    09                   .BYTE   00001001B
   1DA1    0002                 .WORD   2
   1DA3    02240348             .BYTE   2,36,3,72
   1DA7    0048                 .WORD   72
   1DA9    040F00               .BYTE   4,15,0
   1DAC    014C                 .WORD   332
   1DAE    00BF                 .WORD   191
   1DB0    E000                 .BYTE   11100000B,0
   1DB2    0030                 .WORD   48
   1DB4    0002                 .WORD   2
   1DB6    010203040506 TRA09S: .BYTE   1,2,3,4,5,6,7,8
   1DBE    111213141516         .BYTE   17,18,19,20,21,22,23,24
   1DC6    212223242526         .BYTE   33,34,35,36,37,38,39,40                
   1DCE    313233343536         .BYTE   49,50,51,52,53,54,55,56
   1DD6    414243444546         .BYTE   65,66,67,68,69,70,71,72






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 69




   1DDE    090A0B0C0D0E         .BYTE   09,10,11,12,13,14,15,16
   1DE6    191A1B1C1D1E         .BYTE   25,26,27,28,29,30,31,32
   1DEE    292A2B2C2D2E         .BYTE   41,42,43,44,45,46,47,48
   1DF6    393A3B3C3D3E         .BYTE   57,58,59,60,61,62,63,64
   0068                 DLE09S  ==      .-DDB09S
   00AF                 LEN09S  ==      .-TB09S
                        
                        ;8" DOUBLE DENSITY, 1024 BYTE SECTORS
                        ;10 SECTORS PER TRACK = 1.56 MBYTES
   1DFE                 TB10S:
   1DFE    384434               .BYTE   '8','D','4'
   1E01    BF                   .BYTE   LEN8D4  ;<- A LIE, BUT NEEDED FOR INDEX LEN10S
   1E02    B0           D8D006: .BYTE   DCMD8D
   1E03    504E0C0003F6         .BYTE   80,04EH,12,0H,3,0F6H,1,0FCH,50,04EH
   1E0D    0A                   .BYTE   10
   1E0E    0C0003F50103         .BYTE   12,0H,3,0F5H,1,3H,22,04EH,12,0H,3,0F5H
   1E1A    0400                 .WORD   1024
   1E1C    E5364E               .BYTE   0E5H,54,04EH
   1E1F    0320                 .WORD   400+400
   1E21    4E                   .BYTE   04EH
   1E22    20                   .BYTE   ALE10S
   1E23    70                   .BYTE   DLE10S
   1E24    47                   .BYTE   DDB10S-TB10S
   1E25    DDFDDDFD     ALT10S: .BYTE   0DDH,0FDH,0DDH,0FDH
   1E29    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   1E2F    0B                   .BYTE   00001011B
   1E30    0002                 .WORD   2
   1E32    02240350             .BYTE   2,36,3,80
   1E36    0050                 .WORD   80
   1E38    040F00               .BYTE   4,15,0
   1E3B    030C                 .WORD   780
   1E3D    00FF                 .WORD   255             ;MAXIMUM IS 255 (256 ACTUAL)
   1E3F    F000                 .BYTE   11110000B,0
   1E41    0040                 .WORD   64              ;MAXIMUM IS 64
   1E43    0002                 .WORD   2
   0020                 ALE10S  ==      .-ALT10S
   1E45    DDFDDDFD     DDB10S: .BYTE   0DDH,0FDH,0DDH,0FDH
   1E49    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   1E4F    09                   .BYTE   00001001B
   1E50    0002                 .WORD   2
   1E52    02240350             .BYTE   2,36,3,80
   1E56    0050                 .WORD   80
   1E58    040F00               .BYTE   4,15,0
   1E5B    0168                 .WORD   360
   1E5D    00BF                 .WORD   191
   1E5F    E000                 .BYTE   11100000B,0
   1E61    0030                 .WORD   48
   1E63    0002                 .WORD   2
   1E65    010203040506 TRA10S: .BYTE   1,2,3,4,5,6,7,8
   1E6D    111213141516         .BYTE   17,18,19,20,21,22,23,24
   1E75    212223242526         .BYTE   33,34,35,36,37,38,39,40                
   1E7D    313233343536         .BYTE   49,50,51,52,53,54,55,56
   1E85    414243444546         .BYTE   65,66,67,68,69,70,71,72
   1E8D    090A0B0C0D0E         .BYTE   09,10,11,12,13,14,15,16
   1E95    191A1B1C1D1E         .BYTE   25,26,27,28,29,30,31,32






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 70




   1E9D    292A2B2C2D2E         .BYTE   41,42,43,44,45,46,47,48
   1EA5    393A3B3C3D3E         .BYTE   57,58,59,60,61,62,63,64
   1EAD    494A4B4C4D4E         .BYTE   73,74,75,76,77,78,79,80
                                
   0070                 DLE10S  ==      .-DDB10S
   00B7                 LEN10S  ==      .-TB10S
                        ;8" DOUBLE DENSITY, 1024 BYTE SECTORS
                        ;11 SECTORS PER TRACK
   1EB5                 TB11S:
   1EB5    384434               .BYTE   '8','D','4'
   1EB8    BF                   .BYTE   LEN11S          ;<- EQUALS LEN8D4 FOR INDEX
   1EB9    B0           D8D007: .BYTE   DCMD8D
   1EBA    1E4E0C0003F6         .BYTE   30,04EH,12,0H,3,0F6H,1,0FCH,20,04EH
                        ;       .BYTE   80,04EH,12,0H,3,0F6H,1,0FCH,50,04EH ;JUST FOR INTEREST
   1EC4    0B                   .BYTE   11
   1EC5    0C0003F50103         .BYTE   12,0H,3,0F5H,1,3H,22,04EH,12,0H,3,0F5H
   1ED1    0400                 .WORD   1024
   1ED3    E51A4E               .BYTE   0E5H,26,04EH
                        ;       .BYTE   0E5H,54,04EH            ;JUST FOR INTEREST
   1ED6    0320                 .WORD   400+400
   1ED8    4E                   .BYTE   04EH
   1ED9    20                   .BYTE   ALE11S
   1EDA    78                   .BYTE   DLE11S
   1EDB    47                   .BYTE   DDB11S-TB11S
   1EDC    DDFDDDFD     ALT11S: .BYTE   0DDH,0FDH,0DDH,0FDH
   1EE0    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   1EE6    0B                   .BYTE   00001011B
   1EE7    0002                 .WORD   2
   1EE9    02240358             .BYTE   2,36,3,88
   1EED    0058                 .WORD   88
   1EEF    040F00               .BYTE   4,15,0
   1EF2    0340                 .WORD   832
   1EF4    00FF                 .WORD   255             ;MAXIMUM IS 255 (256 ACTUAL)
   1EF6    F000                 .BYTE   11110000B,0
   1EF8    0040                 .WORD   64              ;MAXIMUM IS 64
   1EFA    0002                 .WORD   2
   0020                 ALE11S  ==      .-ALT11S
   1EFC    DDFDDDFD     DDB11S: .BYTE   0DDH,0FDH,0DDH,0FDH
   1F00    000000000000         .BYTE   0H,0H,0H,0H,0H,0H
   1F06    09                   .BYTE   00001001B
   1F07    0002                 .WORD   2
   1F09    02240358             .BYTE   2,36,3,88
   1F0D    0058                 .WORD   88
   1F0F    040F00               .BYTE   4,15,0
   1F12    01A0                 .WORD   416
   1F14    00BF                 .WORD   191
   1F16    E000                 .BYTE   11100000B,0
   1F18    0030                 .WORD   48
   1F1A    0002                 .WORD   2
   1F1C                 TRA11S: 
   1F1C    010203040506         .BYTE   1,2,3,4,5,6,7,8         ;01
   1F24    191A1B1C1D1E         .BYTE   25,26,27,28,29,30,31,32 ;04
   1F2C    292A2B2C2D2E         .BYTE   41,42,43,44,45,46,47,48 ;06
   1F34    393A3B3C3D3E         .BYTE   57,58,59,60,61,62,63,64 ;08
   1F3C    494A4B4C4D4E         .BYTE   73,74,75,76,77,78,79,80 ;10






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 71




   1F44    090A0B0C0D0E         .BYTE   09,10,11,12,13,14,15,16 ;02
   1F4C    212223242526         .BYTE   33,34,35,36,37,38,39,40 ;05
   1F54    313233343536         .BYTE   49,50,51,52,53,54,55,56 ;07
   1F5C    414243444546         .BYTE   65,66,67,68,69,70,71,72 ;09
   1F64    515253545556         .BYTE   81,82,83,84,85,86,87,88 ;11
   1F6C    111213141516         .BYTE   17,18,19,20,21,22,23,24 ;03
                          
   0078                 DLE11S  ==      .-DDB11S
   00BF                 LEN11S  ==      .-TB11S
                        
                        ; OPTION STORAGE.
                        
   1F74    00           QUFLAG: .BYTE   0       ; 0 IF FIRST TIME THROUGH
   1F75                 TRSAV:  .BLKB   1       ; TRACKS - S OR A (System or All)
   1F76                 SISAV:  .BLKB   1       ; SIZE - 5 OR 8
   1F77                 DESAV:  .BLKB   1       ; DENSITY - S OR D (Single or Double)
   1F78                 LESAV:  .BLKB   1       ; SECTOR LENGTH - 1,2,3, OR 4
   1F79                 NESAV:  .BLKB   1       ; TRACKS - S OR E (Standard or Extended 5" drives)      
   1F7A                 SDSAV:  .BLKB   1       ; SIDES - S OR D (Single or Double)
   1F7B                 STDSAV: .BLKB   1       ; SYSTEM TRACKS (Standard or V2BIOS)
   1F7C                 SDFORM: .BLKB   1       ; SIDES TO FORMAT FOR SYSTEM TRACKS
   1F7D                 MEGSAV: .BLKB   1       ; 9, 10 or 11 SPT
   1F7E                 CPMSAV: .BLKB   1
   1F7F                 VERFON: .BLKB   1       ; SKIP READ VERIFY
                        
                        
                        ; MISCELLANEOUS VARIABLES.
                        
   1F80                 DRIVE:  .BLKB   1       ;DISK DRIVE
   1F81                 Z3SBYT: .BLKB   1       ;CURRENT Z3S CONTROL BYTE
   1F82                 Z3SSYS: .BLKB   1       ;SYSTEM TRACK Z3S CONTROL BYTE
   1F83                 TRAKK:  .BLKB   1       ;CURRENT TRACK
   1F84                 MAXTRK: .BLKB   1       ;HIGHEST TRACK
   1F85                 SECTOR: .BLKB   1       ;CURRENT SECTOR
   1F86                 REPEAT: .BLKB   1       ;LOOP VARIABLE
                        
   1F87                 CREATE:                 ;VARIABLES PASSED TO LTABLE
   1F87                 SIZE:   .BLKB   1
   1F88                 DEN:    .BLKB   1
   1F89                 SSIZ:   .BLKB   1
                        
                        
                        ; DISK DESCRIPTION TABLE. THE TABLE WHICH DESCRIBES THE
                        ; DISK TO BE FORMATTED IS MOVED HERE TO ALLOW MORE
                        ; CONVENIENT ACCESS.
                        
   1F8A                 DTABLE:
   1F8A                         .BLKB   4       ;HEADER
   1F8E                 DPROTO: .BLKB   1       ;Z3S PROTOTYPE
   1F8F                 G4AL:   .BLKB   1       ;GAP 4 A
   1F90                 G4AV:   .BLKB   1
   1F91                 INSYAL: .BLKB   1       ;INDEX SYNC PATTENS
   1F92                 INSYAV: .BLKB   1
   1F93                 INSYBL: .BLKB   1
   1F94                 INSYBV: .BLKB   1






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 72




   1F95                 INAML:  .BLKB   1       ;INDEX AM
   1F96                 INAMV:  .BLKB   1
   1F97                 G1L:    .BLKB   1       ;GAP 1
   1F98                 G1V:    .BLKB   1
   1F99                 RPTCNT: .BLKB   1       ;REPEAT COUNT - NUMBER OF SECS
   1F9A                 IDSYAL: .BLKB   1       ;ID SYNC PATTERNS
   1F9B                 IDSYAV: .BLKB   1
   1F9C                 IDSYBL: .BLKB   1
   1F9D                 IDSYBV: .BLKB   1
   1F9E                 LENL:   .BLKB   1       ;SECTOR LENGTH CONTROL BYTE
   1F9F                 LENV:   .BLKB   1
   1FA0                 G2L:    .BLKB   1       ;GAP 2
   1FA1                 G2V:    .BLKB   1
   1FA2                 DASYAL: .BLKB   1       ;DATA SYNC PATTERNS
   1FA3                 DASYAV: .BLKB   1
   1FA4                 DASYBL: .BLKB   1
   1FA5                 DASYBV: .BLKB   1
   1FA6                 DACNTL: .BLKW   1       ;DATA
   1FA8                 DACNTV: .BLKB   1
   1FA9                 G3L:    .BLKB   1       ;GAP 3
   1FAA                 G3V:    .BLKB   1
   1FAB                 G4BL:   .BLKW   1       ;GAP 4
   1FAD                 G4BV:   .BLKB   1
                        
   1FAE                 ALTLEN: .BLKB   1       ;LENGTH OF DOUBLE SIDED
                                                ;DDB WHICH REPLACES STANDARD
   1FAF                 DDBLEN: .BLKB   1       ;LENGTH OF STANDARD DDB
   1FB0                 DDBLOC: .BLKB   1       ;LOCATION OF STANDARD DDB
   1FB1                 ALTDDB: .BLKB   192     ;ALTDDB AND DDB
   00E7                 DLEN    ==      .-DTABLE ;TABLE LENGTH
                        
                        
                        ; HEAD NUMBER AND TRACK NUMBER ADDRESSES SAVED HERE.
                        
   2071                 TRTAB:  .BLKW   50
   0064                 TRLEN   ==      .-TRTAB
                        
                        
                        
                        ;BDOS FUNCTIONS
                        
   0001                         GCON    ==      1       ;GET CONSOL
   0002                         WCON    ==      2       ;OUTPUT CONSOL
   0009                         PRINT   ==      9       ;PRINT STRING
   000A                         GBUF    ==      10      ;GET CONSOL BUFFER
                        
                        ;SYSTEM LOCATIONS
                        
   0005                         BDOS    ==      5       ;LOC OF ENTRY
                        
                        
                        
   20D5                 CRLF2:
   20D5    11 20DE              LXI     D,CRLF1
   20D8    0E09                 MVI     C,PRINT






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 73




   20DA    CD 0005              CALL    BDOS
   20DD    C9                   RET
                                
   20DE                 CRLF1:
   20DE    0A0D0A0D24           .BYTE   LF,CR,LF,CR,24H
                        
                        
   20E3                 ASKFOR:
   20E3    31 0100              LXI     SP,100H
                        
   20E6    CD 1144              CALL    MSGF
   20E9    0D0A0A               .BYTE   CR,LF,LF
   20EC    436865636B20         .ASCII  \Check the diskette and selected drive for binding, \
   211F    0D0A                 .BYTE   CR,LF
   2121    777269746520         .ASCII  \write protection, or wrong media type for format options:\
   215A    0D0A0A               .BYTE   CR,LF,LF
   215D    456E74657220         .ASCIS  \Enter R to (R)etry the same format or N to try a (N)ew format (R,N):\
                        
   21A1    21 14F0              LXI     H,ASKOK
   21A4    CD 1150              CALL    GETOK
   21A7    FE52                 CPI     'R'
   21A9    CA 0100              JZ      FORMAT
   21AC    3E00                 MVI     A,0
   21AE    32 1F74              STA     QUFLAG
   21B1    C3 0100              JMP     FORMAT
                                
                        
                        
                        ; WE DO NOT DO A READ AFTER FULL FORMAT ANYMORE,
                        ; SINCE THAT WAS BIOS DEPENDANT. WE USED TO
                        ; FORMAT THE ENTIRE DISKETTE, THEN COME HERE
                        ; AND EXECUTE CODE THAT READ THE ENTIRE DISKETTE
                        ; THRU THE BIOS. THE OPERATION WAS FAST, BUT IF
                        ; A DISKETTE HAD ERRORS, IT WOULD BE LONGER THAN
                        ; THE READ-VERIFY TESTING NOW USED. IN ADDITION
                        ; THE BIOS READ TESTING COULD NOT WORK WITH
                        ; THE NEW 'STANDARD' FORMAT OPTION, SINCE
                        ; NO SPECIAL SYSTEM TRACKS WITH A DDB ARE
                        ; GENERATED FOR THAT OPTION.
                        
   21B4                 READD:
   21B4                 GOBAK:
   21B4    31 0100              LXI     SP,100H
                        
   21B7    CD 1144              CALL    MSGF
   21BA    1A0D0A0A             .BYTE   CLEAR,CR,LF,LF
   21BE    547970652052         .ASCII  \Type R to return to the command prompt \
   21E5    0D0A                 .BYTE   CR,LF
   21E7    547970652046         .ASCII  \Type F to format another diskette: \
   220A    0D0A0A               .BYTE   CR,LF,LF
   220D    4D616B652073         .ASCIS  \Make sure you have a working System Diskette in your Boot Drive (R,F): \
                        
   2254    21 14E0              LXI     H,QUITOK
   2257    CD 1150              CALL    GETOK
   225A    FE46                 CPI     'F'






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 74




   225C    CA 0100              JZ      FORMAT
   225F                 GOMOR:
   225F                 PIEND:
   225F    C3 0000              JMP     0
   2262                 EEXIT:
   2262    C3 0000              JMP     0
                        
                        ;SET DRIVE TO HOME TRACK
                        
   2265                 HDRV:
   2265    C9                   RET
                        
                        
                        ;CONVERT THE BYTE IN C REG. TO TWO HEX NIBBLES AND PRINT
                        
   2266                 DOHEX:
   2266    79                   MOV     A,C
   2267    E6F0                 ANI     0F0H
   2269    0F                   RRC
   226A    0F                   RRC
   226B    0F                   RRC
   226C    0F                   RRC
   226D    F630                 ORI     30H
   226F    CD 22EF              CALL    COUT
   2272    79                   MOV     A,C
   2273    E60F                 ANI     0FH
   2275    FE0A                 CPI     10
   2277    300B                 JRNC    ALPH
   2279    F630                 ORI     30H
   227B    CD 22EF              CALL    COUT
   227E    3E0D                 MVI     A,CR
   2280    CD 22EF              CALL    COUT
   2283    C9                   RET
   2284    D609         ALPH:   SUI     9
   2286    F640                 ORI     40H
   2288    CD 22EF              CALL    COUT
   228B    3E0D                 MVI     A,CR
   228D    CD 22EF              CALL    COUT
   2290    C9                   RET
                        
   2291    202020202020 TRFMES: .ASCII  \                          formatting cylinder $\
                        
   22C0    202020202020 TRVMES: .ASCII  \                           verifying cylinder $\
                        
                        
   22EF                 COUT:
   22EF    C5                   PUSH    B
   22F0    5F                   MOV     E,A
   22F1    0E02                 MVI     C,WCON
   22F3    CD 0005              CALL    BDOS
   22F6    C1                   POP     B
   22F7    C9                   RET
                        
                        
   22F8                 SKEWTB: .BLKB   88






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 75




   2350    00                   .BYTE   0               ;MARK TABLE END
                        
   2351    010003040506 SKEWGN: .BYTE   1,0,3,4,5,6,0
                         
                        
                                        
                        ; MORE PROGRAM STORAGE
                        ; OH GOSH! SO MANY VARIABLES WERE USED ONCE.
                        ; HERE THEY REMAIN UNTIL ANOTHER CLEANUP
                        
   2358    00           SKEW:   .BYTE   0               ;SKEW TABLE FOR CP/M OR MP/M
   2359    00           VERFLG: .BYTE   0               ;VERSION NUMBER, DEFAULT = CP/M
   235A                 RTNTRK: .BLKB   1               ;RETURN TRACK
   235B                 CTLBYT: .BLKB   1               ;CONTROL LATCH VALUE    
   235C                 BOTVEC: .BLKW   1               ;BOOT O.K. LABEL
   235E    0042         ALTB1:  .BYTE   0,'B'           ;"B" FOR A:
   2360    0042         ALTB2:  .BYTE   0,'B'           ;"B" FOR B:
   2362                 ALBONE: .BLKW   1               ;FIRST LABEL ON A
   2364    00           ANS1:   .BYTE   0               ;SPECIAL "B" FORMAT ALLOWED
   2365                 ACOP:   .BLKW   1               ;VALUE OF "A" DISK #
   2367    00           CPFLG:  .BYTE   0               ;DISK "A" COPIED FLAG
   2368                 CURTRK: .BLKW   1               ;CURRENT TRACK
   236A    0001         TTAB:   .WORD   1               ; WAS DDBB+31-POINTER TO XLATE TABLE
   236C                 SKWPTR: .BLKW   1               ;POINTER TO SKEW TABLE
   236E                 NXTSEC: .BLKW   1               ;NEXT SECTOR TO R/W
   2370                 SOURCE: .BLKB   1               ;SOURCE DRIVE
   2371                 DESTIN: .BLKB   1               ;DESTINATION DRIVE
   2372    01           SCOUNT: .BYTE   1               ;SECT. COUNT 
   2373    00           STRK:   .BYTE   0               ;INITIAL TRACK
   2374                 TADD:   .BLKW   1               ;CURRENT DMA ADDRESS
   2376                 TLENS:  .BLKW   1               ;TRACK LENGTH IN BYTES
   2378                 DPSAV:  .BLKW   1               ;DPH POINTER
   237A                 NDSR:   .BLKB   1               ;NUMBER OF USER SECTORS
   237B                 FMDRV:  .BLKB   1               ;DRIVE THAT WAS FORMATTED
   237C                 CURDRV: .BLKB   1               ;CURRENT DRIVE
   237D                 NDSR1:  .BLKB   1               ;NUMBER OF SECTORS ON A:
   237E                 TLENS1: .BLKW   1               ;TRACK LENGTH ON A:
   2380                 LABA:   .BLKW   1               ;SAVED DRIVE A: LABEL
   2382                 LABB:   .BLKW   1               ;SAVED DRIVE B: LABEL
   2384                 TRKS:   .BLKB   1               ;NUMBER OF DISK TRACKS
   2385                 TNDSR:  .BLKB   1               ;TEMP. # OF USER SECTORS
   2386                 LABNAM: .BLKW   1               ;NAME OF LABEL TO WRITE
   2388                 RTADD:  .BLKW   1               ;POINTER TO READ DMA ADDRESS
   238A                 RSTAT:  .BLKB   1
   238B                 Z3SFLG: .BLKB   1               ;Z3S OR VFII FLAG, 0 = Z3S
   238C    4641494C2043 .ASCII  \FAIL CODES+\
   2397                 FAILED: .BLKB   6               ;SOME FORMAT FAILURE BYTES GO HERE
   239D    46494E414C2B .ASCII  \FINAL+\
   23A3    FFFF         FINAL:  .WORD   0FFFFH
   23A5    46494E464C47 .ASCII  \FINFLG+\
   23AC    00           FINFLG: .BYTE   0
   23AD    43484B464B47 .ASCII  \CHKFKG+\
   23B4    00           CHKFLG: .BYTE   0
   23B5    564552414444 .ASCII  \VERADD+\       
   23BC    FFFF         VERADD: .WORD   0FFFFH






TDL Z80 CP/M DISK ASSEMBLER VERSION 2.21                                                                                   PAGE 76




   23BE    534543434F4D .ASCII  \SECCOM+\
   23C5    FFFF         SECCOM: .WORD   0FFFFH
   23C7    4C454E562B   .ASCII  \LENV+\
   23CC    FF           SECSZ:  .BYTE   0FFH
   23CD    424453495A2B .ASCII  \BDSIZ+\
   23D3    FF           BDSIZ:  .BYTE   0FFH
   23D4    505357534156 .ASCII  \PSWSAV+\
   23DB    FFFF         PSWSAV: .WORD   0FFFFH
                        
   22DD                 PSIZE   ==      .-FORMAT        
   0045                 RSIZE   ==      ((.-FORMAT)/128)
   2280                 SSIZE   ==      RSIZE*128
                        
                                .IFG    PSIZE-SSIZE,[
                        
   0046                         MRECS   ==      RSIZE+1
                                        ][
                                MRECS   ==      RSIZE
                                        ]
                                
                        
                        ;----------------------------------------------
                        ; OLD DDB SAVE SPACE - OMIT IT HERE WITH ";"
                        ;
                        ;DDBB:
                        ;       .BLKB   128     ;DDB READ BUFFER
                        ;DDB1:
                        ;       .BLKB   128     ;DRIVE B DDB BUFFER
                        ;----------------------------------------------
                        
                        ; UPR TO 14K OF AREA FOR PROTOTYPE TRACK 
                        
   23DD                 TBEGIN:
                        
                        ; THEN UP TO 11 K FOR A VERIFY READ BUFFER      
                        
                        
                                .END




















                                               